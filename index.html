<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>SIN NADA QUE OCULTAR ‚Äî Edici√≥n Period√≠stica Profesional</title>
  <meta name="color-scheme" content="light dark" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Source+Serif+4:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f7f9fb;
      --paper:#ffffff;
      --text:#111418;
      --muted:#5b6b7e;
      --headline:#0f2a4d;
      --accent:#1d62ff;
      --accent-2:#0b8e6e;
      --border:#e3e8ef;
      --border-strong:#cbd5e1;
      --danger:#d92d20;
      --ok:#12b76a;
      --warn:#f59e0b;
      --chip:#eef2f7;
      --shadow:0 10px 24px rgba(17,20,24,.08);
      --shadow-sm:0 4px 10px rgba(17,20,24,.06);
      --safe-bottom: env(safe-area-inset-bottom);
    }
    @media (prefers-color-scheme: dark) {
      :root{
        --bg:#0c1116;
        --paper:#0f141a;
        --text:#eaf0f7;
        --muted:#99a3af;
        --headline:#bcd1ff;
        --accent:#6ba3ff;
        --accent-2:#34d399;
        --border:#1f2937;
        --border-strong:#2b3646;
        --chip:#121821;
        --shadow:0 14px 30px rgba(0,0,0,.35);
        --shadow-sm:0 6px 16px rgba(0,0,0,.25);
      }
    }

    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto;scroll-behavior:smooth}
    img,video,iframe{max-width:100%;display:block}
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}
    .serif{font-family:"Source Serif 4",serif}

    /* Header period√≠stico: barra superior sobria con cintillo y navegaci√≥n fija */
    header{
      position:sticky;top:0;z-index:200;background:var(--paper);
      border-bottom:1px solid var(--border);
      box-shadow:var(--shadow-sm);
    }
    .nav{
      max-width:1280px;margin:0 auto;padding:12px 16px;
      display:grid;grid-template-columns:auto 1fr auto auto auto;gap:12px;align-items:center;
    }
    @media(max-width:980px){ .nav{ grid-template-columns:auto auto 1fr auto } }
    .brand{display:flex;align-items:center;gap:12px}
    .brand-logo{width:40px;height:40px;border-radius:8px;overflow:hidden;border:1px solid var(--border-strong);background:var(--chip)}
    .brand-title{line-height:1}
    .brand-title h1{margin:0;font-size:18px;color:var(--headline);font-weight:800;letter-spacing:.2px}
    .brand-title .slogan{margin-top:2px;color:var(--muted);font-size:12px}

    .search{display:flex;align-items:center;gap:8px}
    .search-input{
      width:100%;min-width:260px;background:var(--chip);
      border:1px solid var(--border);border-radius:999px;padding:10px 14px;
      color:var(--text);font-size:14px;
    }
    .search-input::placeholder{color:var(--muted)}
    .btn{border:1px solid var(--border-strong);background:var(--paper);color:var(--text);border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer}
    .btn:hover{background-color:#f0f4f9}
    .btn-primary{background:var(--accent);color:#fff;border-color:transparent}
    .btn-primary:hover{filter:brightness(1.05)}
    .btn-outline{background:var(--paper);color:var(--accent);border:1px solid var(--accent)}
    .avatar{width:32px;height:32px;border-radius:50%;border:1px solid var(--border);object-fit:cover}

    .tabs{
      border-top:1px solid var(--border);
      background:var(--paper);
    }
    .tabs-inner{
      max-width:1280px;margin:0 auto;padding:0 16px;
      display:flex;align-items:center;gap:10px;overflow:auto;
    }
    .tab{
      background:transparent;border:none;padding:12px 8px;color:var(--muted);font-weight:800;cursor:pointer;flex:0 0 auto;
    }
    .tab.active{color:var(--text);border-bottom:2px solid var(--accent)}

    /* Ticker de titulares (cintillo) */
    .ticker{
      background:var(--paper);border-bottom:1px solid var(--border);
    }
    .ticker-inner{max-width:1280px;margin:0 auto;padding:8px 16px;overflow:hidden}
    .marquee{white-space:nowrap;animation:marq 60s linear infinite}
    .headline-pill{display:inline-flex;align-items:center;gap:10px;margin-right:24px}
    .headline-pill .tag{font-size:12px;color:var(--muted);background:var(--chip);padding:4px 8px;border-radius:999px;border:1px solid var(--border)}
    .headline-pill .title{font-weight:800;color:var(--text)}
    @keyframes marq{from{transform:translateX(100%)}to{transform:translateX(-100%)}}

    /* Layout principal: columna de lectura + sidebar */
    .layout{
      max-width:1280px;margin:0 auto;padding:16px;
      display:grid;grid-template-columns:minmax(0,1fr) 340px;gap:20px;
    }
    @media(max-width:1100px){ .layout{ grid-template-columns:1fr } }

    /* Card gen√©rica */
    .card{
      background:var(--paper);border:1px solid var(--border);
      border-radius:12px;box-shadow:var(--shadow);padding:14px;margin-bottom:14px;
    }
    .card h4{margin:0 0 8px;font-size:16px;color:var(--headline)}
    .card .sub{font-size:12px;color:var(--muted);margin-bottom:10px}

    /* Post estilo art√≠culo */
    .post{background:var(--paper);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:16px;box-shadow:var(--shadow)}
    .post-head{display:flex;gap:12px;align-items:center;margin-bottom:8px}
    .post-head .ph-right{flex:1;min-width:0}
    .post-author{font-weight:800}
    .post-meta{color:var(--muted);font-size:12px}
    .post-title{margin:8px 0 6px;font-size:20px;font-weight:800;color:var(--text)}
    .post-desc{margin:0 0 8px;color:var(--muted)}
    .post-content{margin-top:8px;color:var(--text);line-height:1.7}
    .post-content p{margin:8px 0}
    .tag-row{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0}
    .tag{font-size:12px;border:1px solid var(--border);border-radius:999px;padding:4px 10px;color:var(--muted);background:var(--chip)}
    .featured-video{width:100%;aspect-ratio:16/9;border:1px solid var(--border);border-radius:10px;background:#000;margin:10px 0}
    .gallery{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    .gallery img{width:100%;height:220px;object-fit:cover;border-radius:10px;border:1px solid var(--border);cursor:pointer}
    @media(max-width:640px){.gallery{grid-template-columns:1fr}}

    .actions{display:flex;gap:16px;margin-top:10px;color:var(--muted);font-size:14px}
    .action-btn{background:none;border:none;color:inherit;cursor:pointer;padding:6px;border-radius:8px}
    .action-btn.active{color:var(--accent);font-weight:800}
    .author-actions{margin-left:auto;display:flex;gap:8px}
    .btn-mini{border:1px solid var(--border);background:var(--paper);border-radius:8px;padding:6px 10px;font-size:12px;cursor:pointer}
    .btn-danger{border-color:var(--danger);color:#fff;background:var(--danger)}

    /* Comentarios */
    .comments{margin-top:12px;border-top:1px solid var(--border);padding-top:12px}
    .comments h4{margin:0 0 8px;font-size:15px;color:var(--headline)}
    .comment-item{display:flex;gap:10px;margin-bottom:10px}
    .comment-avatar{width:28px;height:28px;border-radius:50%;border:1px solid var(--border)}
    .comment-box{flex:1;border:1px solid var(--border);border-radius:10px;padding:8px;background:var(--paper)}
    .comment-meta{display:flex;justify-content:space-between;color:var(--muted);font-size:12px;margin-bottom:4px}
    .comment-text{font-size:14px}
    .comment-actions{display:flex;gap:8px;margin-top:6px}
    .comment-action{background:none;border:1px solid var(--border);border-radius:999px;padding:4px 8px;font-size:12px;color:var(--muted);cursor:pointer}
    .comment-form{display:flex;gap:8px;margin-top:8px}
    .comment-input{flex:1;border:1px solid var(--border);border-radius:999px;padding:8px;background:var(--paper)}
    .comment-btn{border:none;border-radius:999px;padding:8px 12px;background:var(--accent);color:#fff;font-weight:800;cursor:pointer}

    /* Sidebar listas editoriales */
    .list-row{display:flex;align-items:center;justify-content:space-between;gap:8px;margin:8px 0}
    .list-left{display:flex;align-items:center;gap:10px}
    .list-left img{width:28px;height:28px;border-radius:50%;border:1px solid var(--border)}

    /* Mobile tabs fijas, estilo app de noticias */
    .mobile-tabs{display:none}
    @media(max-width:980px){
      .mobile-tabs{
        display:flex;position:fixed;left:0;right:0;bottom:0;background:var(--paper);border-top:1px solid var(--border);
        padding:8px calc(8px + var(--safe-bottom));justify-content:space-around;z-index:180
      }
      .mobile-tabs button{background:none;border:none;color:var(--muted);font-weight:800}
      .mobile-tabs button.active{color:var(--accent)}
      .layout{padding-bottom:72px}
    }

    /* Modales */
    .backdrop{position:fixed;inset:0;background:rgba(12,17,22,.4);display:none;align-items:center;justify-content:center;z-index:220}
    .modal{background:var(--paper);border:1px solid var(--border);border-radius:12px;max-width:780px;width:94%;padding:16px;box-shadow:var(--shadow)}
    .modal-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .modal-title{font-weight:800;color:var(--headline)}
    .close-x{background:none;border:none;color:var(--muted);font-weight:800;cursor:pointer}
    .inputs{display:grid;gap:8px}
    .inputs input,.inputs textarea,.inputs select{width:100%;border:1px solid var(--border);border-radius:10px;padding:10px;background:var(--paper)}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0}
    .tool{border:1px solid var(--border);background:var(--paper);border-radius:999px;padding:6px 10px;font-size:12px;cursor:pointer}
    .editor{min-height:160px;border:1px solid var(--border);border-radius:10px;padding:10px;background:var(--paper)}
    .modal-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:10px}

    /* Notificaciones */
    .notif{position:relative}
    .notif-btn{background:none;border:1px solid var(--border);border-radius:10px;padding:8px 12px;color:var(--muted);font-weight:800;cursor:pointer}
    .notif-badge{display:none;margin-left:6px;background:var(--danger);color:#fff;border-radius:999px;padding:2px 6px;font-size:12px}
    .notif-panel{position:absolute;top:110%;right:0;background:var(--paper);border:1px solid var(--border);border-radius:12px;min-width:340px;display:none;box-shadow:var(--shadow)}
    .notif-panel h4{margin:10px 12px;color:var(--headline)}
    .notif-list{max-height:340px;overflow:auto}
    .notif-item{border-top:1px solid var(--border);padding:10px 12px;font-size:14px;color:var(--text);cursor:pointer}
    .notif-item:hover{background:#f3f6fa}
    .notif-actions{display:flex;gap:8px;margin:10px 12px}
    .notif-actions .btn-mini{padding:6px 10px}
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <nav class="nav">
      <div class="brand">
        <div class="brand-logo">
          <img alt="Logo" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjS8LXAzi1Yiook-sOoY1qALICMCqeaZIYKCGeGogvvyhP85GNNKH2nPshVJBRtdggNYOAB4JYP10iMRH7FD4887JXS9yiaY6g0dtRqkgj9Vmbuql5VqpzJ0gwUxsMzERwBlKxHbwUTFIwtBWJVPT-Du-HSg8gsbkIz4cl32AWD9fjbtm9p3FDnq4_Wpdc/s320/gg843.png" style="width:100%;height:100%;object-fit:contain">
        </div>
        <div class="brand-title">
          <h1 class="serif">SIN NADA QUE OCULTAR</h1>
          <div class="slogan">Edici√≥n profesional ‚Äî prensa y comunidad</div>
        </div>
      </div>
      <div class="search">
        <input id="searchInput" class="search-input" type="text" placeholder="Buscar titulares, autores y etiquetas‚Ä¶">
      </div>
      <button id="openComposer" class="btn btn-primary">Publicar</button>
      <button id="googleBtn" class="btn btn-outline">Iniciar</button>
      <div id="userChip" style="display:none;align-items:center;gap:8px">
        <img id="userAvatar" class="avatar" alt="avatar">
        <span id="userName" style="font-weight:800"></span>
        <button id="openDashboard" class="btn">Dashboard</button>
        <button id="logoutBtn" class="btn">Salir</button>
      </div>
      <div class="notif" id="notif">
        <button id="notifBtn" class="notif-btn">Alertas<span id="notifBadge" class="notif-badge">0</span></button>
        <div id="notifPanel" class="notif-panel">
          <h4>Notificaciones</h4>
          <div id="notifList" class="notif-list">
            <div class="notif-item">Sin notificaciones.</div>
          </div>
          <div class="notif-actions">
            <button id="notifMarkRead" class="btn-mini">Marcar le√≠das</button>
            <button id="notifClearAll" class="btn-mini">Limpiar</button>
            <button id="notifClose" class="btn-mini">Cerrar</button>
          </div>
        </div>
      </div>
    </nav>
    <div class="tabs">
      <div class="tabs-inner">
        <button id="tabAll" class="tab active">Portada</button>
        <button id="tabFollowingFeed" class="tab">Seguidos</button>
        <button id="tabInvestigacion" class="tab">Investigaci√≥n</button>
        <button id="tabOpinion" class="tab">Opini√≥n</button>
        <button id="tabAyuda" class="tab">Ayuda</button>
      </div>
    </div>
  </header>

  <!-- Cintillo de titulares -->
  <section class="ticker">
    <div class="ticker-inner">
      <div id="marquee" class="marquee"></div>
    </div>
  </section>

  <!-- Layout principal -->
  <section class="layout">
    <main>
      <div class="card">
        <h4>Portada</h4>
        <div class="sub">Cr√≥nicas y reportes verificados de la comunidad</div>
        <div id="feedControls" style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px">
          <button id="clearSearch" class="btn">Limpiar b√∫squeda</button>
        </div>
        <div id="posts"></div>
        <div id="emptyFeed" class="sub">No hay publicaciones a√∫n.</div>
      </div>
    </main>

    <aside>
      <div class="card">
        <h4>Tu perfil</h4>
        <div class="list-row">
          <div class="list-left">
            <img id="profileAvatar" alt="Yo" class="avatar" style="width:32px;height:32px">
            <div>
              <div id="profileName" style="font-weight:800"></div>
              <div id="profileEmail" style="font-size:12px;color:var(--muted)"></div>
            </div>
          </div>
          <button id="openDashboardSide" class="btn-mini">Dashboard</button>
        </div>
      </div>

      <div class="card">
        <h4>Destacados</h4>
        <div id="topAuthors"></div>
      </div>

      <div class="card">
        <h4>Art√≠culos m√°s aplaudidos</h4>
        <div id="topPosts"></div>
      </div>

      <div class="card">
        <h4>Etiquetas frecuentes</h4>
        <div id="topTags"></div>
      </div>

      <div class="card">
        <h4>Tu progreso</h4>
        <div class="list-row"><span>Publicaciones</span><span id="statPosts">0</span></div>
        <div class="list-row"><span>Likes acumulados</span><span id="statLikes">0</span></div>
        <div class="list-row"><span>Donaci√≥n</span><span id="statDonation">OFF</span></div>
      </div>
    </aside>
  </section>

  <!-- Mobile tabs -->
  <div class="mobile-tabs">
    <button id="tabHome" class="active">Inicio</button>
    <button id="tabCompose">Publicar</button>
    <button id="tabNotif">Alertas</button>
    <button id="tabProfile">Perfil</button>
  </div>

  <!-- Composer -->
  <div id="composerModal" class="backdrop">
    <div class="modal">
      <div class="modal-head">
        <div class="modal-title">Nueva publicaci√≥n</div>
        <button class="close-x" id="closeComposer">√ó</button>
      </div>
      <div class="inputs">
        <input id="titleInput" type="text" placeholder="T√≠tulo" maxlength="120">
        <textarea id="descInput" placeholder="Entradilla / descripci√≥n" rows="3" maxlength="280"></textarea>
        <input id="tagsInput" type="text" placeholder="Etiquetas (coma: pol√≠tica, sociedad)">
        <input id="youtubeInput" type="url" placeholder="URL de YouTube (video/short/live)">
        <select id="contentType">
          <option value="texto">Texto</option>
          <option value="imagen">Im√°genes</option>
          <option value="video">Video de YouTube</option>
        </select>
      </div>
      <div class="toolbar">
        <button class="tool" data-cmd="bold">Negrita</button>
        <button class="tool" data-cmd="italic">Cursiva</button>
        <button class="tool" data-cmd="underline">Subrayado</button>
        <button class="tool" data-cmd="insertUnorderedList">Lista</button>
        <button class="tool" data-cmd="formatBlock" data-value="blockquote">Cita</button>
        <button class="tool" id="linkBtn">Enlace</button>
        <button class="tool" data-cmd="formatBlock" data-value="h2">H2</button>
        <button class="tool" data-cmd="formatBlock" data-value="h3">H3</button>
        <button class="tool" id="clearFormat">Limpiar formato</button>
      </div>
      <div id="editor" class="editor" contenteditable="true"><p>Escribe o pega tu contenido‚Ä¶</p></div>
      <div class="inputs">
        <input id="mediaInput" type="file" accept="image/*" multiple>
        <div id="mediaPreview" style="display:flex;gap:8px;flex-wrap:wrap"></div>
      </div>
      <div class="modal-actions">
        <button id="publishBtn" class="btn btn-primary">Publicar</button>
        <button id="resetBtn" class="btn">Reset</button>
      </div>
    </div>
  </div>

  <!-- Post edit -->
  <div id="postEditModal" class="backdrop">
    <div class="modal">
      <div class="modal-head">
        <div class="modal-title">Editar publicaci√≥n</div>
        <button class="close-x" id="closePostEdit">√ó</button>
      </div>
      <div class="inputs">
        <input id="editTitleInput" type="text" placeholder="T√≠tulo" maxlength="120">
        <textarea id="editDescInput" placeholder="Entradilla / descripci√≥n" rows="3" maxlength="280"></textarea>
        <input id="editTagsInput" type="text" placeholder="Etiquetas">
        <input id="editYoutubeInput" type="url" placeholder="URL YouTube">
      </div>
      <div id="editEditor" class="editor" contenteditable="true"></div>
      <div class="modal-actions">
        <button id="savePostEditBtn" class="btn btn-primary">Guardar</button>
        <button id="cancelPostEditBtn" class="btn">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Lightbox -->
  <div id="lightbox" class="backdrop">
    <div class="modal" style="max-width:900px">
      <button class="close-x" id="lightboxClose" style="align-self:flex-end">Cerrar</button>
      <div id="lightboxContent"></div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>

  <script>
    /* Firebase */
    const firebaseConfig = {
      apiKey: "AIzaSyBWqJI7OKZcEjN2CeTZxPi8pWzo8rBMIkI",
      authDomain: "nearmemarketplace-ce82b.firebaseapp.com",
      projectId: "nearmemarketplace-ce82b",
      storageBucket: "nearmemarketplace-ce82b.firebasestorage.app",
      messagingSenderId: "711845990024",
      appId: "1:711845990024:web:7948ad5e5606765514d93d",
      measurementId: "G-X75JHEDQJ0"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const firestore = firebase.firestore();

    /* Cloudinary (restaurado) */
    window.CLOUDINARY = {
      cloudName: "dxbahdjk1",
      unsignedPreset: "nearmemarketplace",
      folder: "nearmemarketplace/"
    };

    async function uploadToCloudinary(file){
      const url = `https://api.cloudinary.com/v1_1/${window.CLOUDINARY.cloudName}/upload`;
      const formData = new FormData();
      formData.append("file", file);
      formData.append("upload_preset", window.CLOUDINARY.unsignedPreset);
      formData.append("folder", window.CLOUDINARY.folder);
      const res = await fetch(url, { method:"POST", body:formData });
      const data = await res.json();
      if (!res.ok || !data.secure_url) throw new Error(data.error?.message || "Error subiendo a Cloudinary");
      return data.secure_url;
    }

    /* UI helpers */
    function lockBody(){ document.body.style.overflow='hidden'; }
    function unlockBody(){ document.body.style.overflow=''; }
    function show(el){ el.style.display='flex'; }
    function hide(el){ el.style.display='none'; }
    function escapeHtml(str){ return String(str).replace(/[&<>"']/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[s])); }

    /* Auth */
    const googleBtn = document.getElementById('googleBtn');
    const userChip = document.getElementById('userChip');
    const userAvatar = document.getElementById('userAvatar');
    const userName = document.getElementById('userName');
    const logoutBtn = document.getElementById('logoutBtn');

    googleBtn.addEventListener('click', async () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      try { await auth.signInWithPopup(provider); } catch (e) { alert('Error al iniciar: ' + e.message); }
    });
    logoutBtn.addEventListener('click', async () => { await auth.signOut(); });

    /* Notifications */
    const notifBtn = document.getElementById('notifBtn');
    const notifBadge = document.getElementById('notifBadge');
    const notifPanel = document.getElementById('notifPanel');
    const notifList = document.getElementById('notifList');
    const notifMarkRead = document.getElementById('notifMarkRead');
    const notifClearAll = document.getElementById('notifClearAll');
    const notifClose = document.getElementById('notifClose');
    let notifUnsub=null; let notifications=[];

    function notifCol(uid){ return firestore.collection('users').doc(uid).collection('notifications'); }

    function renderNotifications(){
      notifList.innerHTML = '';
      if (!notifications.length) {
        notifList.innerHTML = '<div class="notif-item">Sin notificaciones.</div>';
      } else {
        notifications.forEach(n=>{
          const div = document.createElement('div'); div.className='notif-item';
          div.textContent = `${new Date(n.ts).toLocaleString()} ‚Ä¢ ${n.msg}`;
          div.addEventListener('click', ()=>{
            if (n.target?.postId) openPostViewInline(n.target.postId, n.target.commentId||null);
            notifPanel.style.display='none';
          });
          notifList.appendChild(div);
        });
      }
      const unread = notifications.filter(n=>!n.read).length;
      notifBadge.textContent = unread;
      notifBadge.style.display = unread ? 'inline-block' : 'none';
    }

    function subscribeMyNotifications(){
      if (notifUnsub){ try{notifUnsub();}catch{} notifUnsub=null; }
      const u = auth.currentUser; if (!u) { notifications=[]; renderNotifications(); return; }
      notifUnsub = notifCol(u.uid).orderBy('ts','desc').onSnapshot(s=>{
        notifications = []; s.forEach(d=> notifications.push(d.data())); renderNotifications();
      });
    }

    async function pushNotification(toUid, text, target=null){
      const id = String(Date.now()+Math.random());
      const payload = { id, uidOwner: toUid, msg:text, ts: Date.now(), read:false };
      if (target) payload.target = target;
      await notifCol(toUid).doc(id).set(payload);
    }

    async function clearAllNotifications(){
      const u = auth.currentUser; if (!u) return;
      const snap = await notifCol(u.uid).get();
      const batch = firestore.batch();
      snap.forEach(doc=> batch.delete(doc.ref));
      await batch.commit();
    }
    async function markAllRead(){
      const u = auth.currentUser; if (!u) return;
      const snap = await notifCol(u.uid).get();
      const batch = firestore.batch();
      snap.forEach(doc=> batch.update(doc.ref, { read:true }));
      await batch.commit();
    }

    notifBtn.addEventListener('click', ()=>{
      notifPanel.style.display = notifPanel.style.display==='block' ? 'none' : 'block';
    });
    notifClose.addEventListener('click', ()=> notifPanel.style.display='none');
    notifMarkRead.addEventListener('click', async ()=>{ await markAllRead(); });
    notifClearAll.addEventListener('click', async ()=>{ await clearAllNotifications(); });
    document.addEventListener('click', (e)=>{ if (!document.getElementById('notif').contains(e.target)) notifPanel.style.display='none'; });

    /* Following */
    let myFollowingSet = new Set();
    async function refreshFollowing(){
      const u = auth.currentUser; myFollowingSet = new Set();
      if (!u) return;
      const snap = await firestore.collection('users').doc(u.uid).get();
      const arr = Array.from(new Set((snap.data()?.following)||[]));
      myFollowingSet = new Set(arr);
    }

    async function toggleFollow(targetUid, name, avatar, btn){
      const u = auth.currentUser; if (!u){ alert('Inicia sesi√≥n para seguir.'); return; }
      if (u.uid === targetUid){ alert('No puedes seguirte a ti mismo.'); return; }

      const meRef = firestore.collection('users').doc(u.uid);
      const targetRef = firestore.collection('users').doc(targetUid);

      await firestore.runTransaction(async tx=>{
        const meSnap = await tx.get(meRef);
        const targetSnap = await tx.get(targetRef);
        const meData = meSnap.exists ? meSnap.data() : { following: [] };
        const targetData = targetSnap.exists ? targetSnap.data() : { followers: [] };

        const followingSet = new Set(meData.following || []);
        const followersSet = new Set(targetData.followers || []);
        const isFollowing = followingSet.has(targetUid);

        if (isFollowing) { followingSet.delete(targetUid); followersSet.delete(u.uid); }
        else { followingSet.add(targetUid); followersSet.add(u.uid); }

        tx.set(meRef, { name: u.displayName || u.email || 'Usuario', avatar: u.photoURL || null, following: Array.from(followingSet) }, { merge:true });
        tx.set(targetRef, { name, avatar, followers: Array.from(followersSet) }, { merge:true });

        if (!isFollowing) { try{ await pushNotification(targetUid, `${u.displayName || 'Usuario'} te sigui√≥`, null); }catch{} }

        if (btn){
          const nowFollowing = !isFollowing;
          btn.textContent = nowFollowing ? 'Siguiendo' : 'Seguir';
        }
      });

      await refreshFollowing();
      renderFeed();
    }

    /* Tabs */
    const tabAll = document.getElementById('tabAll');
    const tabFollowingFeed = document.getElementById('tabFollowingFeed');
    let feedMode = 'all';
    function setFeedMode(mode){
      feedMode = mode;
      tabAll.classList.toggle('active', mode==='all');
      tabFollowingFeed.classList.toggle('active', mode==='following');
      renderFeed();
    }
    tabAll.addEventListener('click', ()=> setFeedMode('all'));
    tabFollowingFeed.addEventListener('click', ()=> setFeedMode('following'));

    /* Composer */
    const composerModal = document.getElementById('composerModal');
    const openComposer = document.getElementById('openComposer');
    const closeComposer = document.getElementById('closeComposer');
    const editor = document.getElementById('editor');
    const linkBtn = document.getElementById('linkBtn');
    const clearFormat = document.getElementById('clearFormat');
    const mediaInput = document.getElementById('mediaInput');
    const mediaPreview = document.getElementById('mediaPreview');

    let selectedFiles = [];
    openComposer.addEventListener('click', ()=>{ if (!auth.currentUser){ alert('Inicia sesi√≥n para publicar.'); return; } show(composerModal); lockBody(); });
    closeComposer.addEventListener('click', ()=>{ hide(composerModal); unlockBody(); });
    composerModal.addEventListener('click', (e)=>{ if(e.target===composerModal){ hide(composerModal); unlockBody(); } });

    document.querySelectorAll('.tool').forEach(btn=>{
      const cmd = btn.dataset.cmd;
      const val = btn.dataset.value;
      if (cmd && cmd!=='formatBlock') btn.addEventListener('click', ()=> document.execCommand(cmd, false, null));
      else if (cmd==='formatBlock') btn.addEventListener('click', ()=> document.execCommand('formatBlock', false, val));
    });
    linkBtn.addEventListener('click', ()=>{ const url = prompt('URL:'); if (url) document.execCommand('createLink', false, url); });
    clearFormat.addEventListener('click', ()=> document.execCommand('removeFormat', false, null));

    mediaInput.addEventListener('change', ()=>{
      selectedFiles = Array.from(mediaInput.files);
      mediaPreview.innerHTML = '';
      selectedFiles.forEach(f=>{
        const img = document.createElement('img');
        img.src = URL.createObjectURL(f);
        img.style.width='120px'; img.style.height='80px'; img.style.objectFit='cover'; img.style.border='1px solid var(--border)'; img.style.borderRadius='8px';
        mediaPreview.appendChild(img);
      });
    });

    /* Publish */
    const publishBtn = document.getElementById('publishBtn');
    const resetBtn = document.getElementById('resetBtn');
    const titleInput = document.getElementById('titleInput');
    const descInput = document.getElementById('descInput');
    const tagsInput = document.getElementById('tagsInput');
    const youtubeInput = document.getElementById('youtubeInput');
    const contentType = document.getElementById('contentType');

    function extractYouTubeId(url){
      if (!url) return null;
      try{
        const u = new URL(url);
        if (u.hostname.includes('youtube.com')) {
          if (u.pathname.startsWith('/live/')) return u.pathname.split('/live/')[1];
          const shorts = u.pathname.match(/^\/shorts\/([A-Za-z0-9_-]+)/);
          if (shorts) return shorts[1];
          return u.searchParams.get('v');
        }
        if (u.hostname.includes('youtu.be')) return u.pathname.replace('/','');
      }catch{}
      return null;
    }

    publishBtn.addEventListener('click', async ()=>{
      const u = auth.currentUser; if (!u){ alert('Inicia sesi√≥n para publicar.'); return; }
      const title = titleInput.value.trim();
      const desc = descInput.value.trim();
      const bodyHtml = editor.innerHTML.trim();
      const tags = tagsInput.value.split(',').map(t=>t.trim().toLowerCase()).filter(Boolean);
      const type = contentType.value;
      if (!title || !desc || !bodyHtml){ alert('T√≠tulo, descripci√≥n y contenido son obligatorios.'); return; }

      try {
        const media = [];
        const ytId = extractYouTubeId(youtubeInput.value.trim());
        if (ytId) media.push({ type:'youtube', videoId: ytId });

        if (selectedFiles.length){
          for (const f of selectedFiles){
            const url = await uploadToCloudinary(f);
            media.push({ type:'image', url });
          }
        }

        await firestore.collection('posts').add({
          title, desc, bodyHtml, tags, type,
          media,
          author: { uid: u.uid, name: u.displayName || u.email || 'Usuario', avatar: u.photoURL || null },
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          likesCount: 0, likedBy: [],
          donationEnabled: false
        });

        titleInput.value=''; descInput.value=''; tagsInput.value=''; youtubeInput.value=''; contentType.value='texto';
        editor.innerHTML='<p>Escribe o pega tu contenido‚Ä¶</p>';
        mediaInput.value=''; selectedFiles=[]; mediaPreview.innerHTML='';
        hide(composerModal); unlockBody();

        await pushNotification(u.uid, `Publicaste "${title}"`, null);
      } catch(e) {
        alert('Error publicando: ' + e.message);
      }
    });

    resetBtn.addEventListener('click', ()=>{
      titleInput.value=''; descInput.value=''; tagsInput.value=''; youtubeInput.value=''; contentType.value='texto';
      editor.innerHTML='<p>Escribe o pega tu contenido‚Ä¶</p>';
      mediaInput.value=''; selectedFiles=[]; mediaPreview.innerHTML='';
    });

    /* Feed + titulares + stats */
    const postsContainer = document.getElementById('posts');
    const emptyFeed = document.getElementById('emptyFeed');
    const marquee = document.getElementById('marquee');
    const searchInputEl = document.getElementById('searchInput');
    const clearSearch = document.getElementById('clearSearch');

    let postsCache=[]; let likesBaseline=new Map(); let searchQuery='';

    searchInputEl.addEventListener('input', ()=>{
      searchQuery = searchInputEl.value.trim().toLowerCase();
      renderFeed();
    });
    clearSearch.addEventListener('click', ()=>{
      searchInputEl.value=''; searchQuery=''; renderFeed();
    });

    firestore.collection('posts').orderBy('createdAt','desc').onSnapshot(snap=>{
      postsCache=[]; likesBaseline.clear();
      if (snap.empty){
        postsContainer.innerHTML=''; emptyFeed.style.display='block'; marquee.innerHTML='';
        renderSidebar([]); return;
      }
      emptyFeed.style.display='none';

      snap.forEach(doc=>{
        const d = doc.data();
        let createdText='‚Äî'; try{ if(d.createdAt?.toDate) createdText = d.createdAt.toDate().toLocaleString(); }catch{}
        postsCache.push({ id:doc.id, data:{...d, createdText} });
        likesBaseline.set(doc.id, d.likesCount||0);
      });

      renderFeed();
      renderHeadlines(postsCache.slice(0,60));
      renderSidebar(postsCache);
      loadRightColumnStats();
      subscribeMyNotifications();
    });

    function renderFeed(){
      postsContainer.innerHTML='';
      let list = [...postsCache];

      if (feedMode==='following' && auth.currentUser) {
        list = list.filter(p => myFollowingSet.has(p.data.author?.uid));
      }

      if (searchQuery){
        list = list.filter(p=>{
          const t=(p.data.title||'').toLowerCase();
          const d=(p.data.desc||'').toLowerCase();
          const a=(p.data.author?.name||'').toLowerCase();
          const tags=(p.data.tags||[]).join(' ').toLowerCase();
          return t.includes(searchQuery) || d.includes(searchQuery) || a.includes(searchQuery) || tags.includes(searchQuery);
        });
      }

      if (!list.length){ emptyFeed.style.display='block'; return; } else { emptyFeed.style.display='none'; }
      list.forEach(p=> postsContainer.appendChild(renderPostCard(p.id, p.data)));
    }

    function renderHeadlines(list){
      marquee.innerHTML='';
      const seq = [...list, ...list];
      seq.forEach(p=>{
        const d = p.data;
        const pill = document.createElement('span'); pill.className='headline-pill';
        const tags = (d.tags||[]).slice(0,3).join(' ‚Ä¢ ') || 'sin etiquetas';
        pill.innerHTML = `<span class="tag">${escapeHtml(tags)}</span> <span class="title">üì∞ ${escapeHtml(d.title || '(sin t√≠tulo)')}</span>`;
        pill.addEventListener('click', ()=> openPostViewInline(p.id, null));
        marquee.appendChild(pill);
      });
    }

    function renderPostCard(id, p){
      const u = auth.currentUser;
      const card = document.createElement('article'); card.className='post';

      const head = document.createElement('div'); head.className='post-head';
      const av = document.createElement('img'); av.className='avatar'; av.src = p.author?.avatar || 'https://abs.twimg.com/sticky/default_profile_images/default_profile_normal.png';
      const right = document.createElement('div'); right.className='ph-right';
      const author = document.createElement('div'); author.className='post-author'; author.textContent = p.author?.name || 'Usuario';
      const meta = document.createElement('div'); meta.className='post-meta'; meta.textContent = p.createdText;
      right.appendChild(author); right.appendChild(meta);

      const followBtn = document.createElement('button');
      if (u?.uid !== p.author?.uid) {
        followBtn.className='btn-mini';
        followBtn.textContent='Seguir';
        followBtn.addEventListener('click', ()=> toggleFollow(p.author?.uid, p.author?.name, p.author?.avatar, followBtn));
        if (u) {
          firestore.collection('users').doc(u.uid).get().then(s=>{
            const following = (s.data()?.following)||[];
            const isFollowing = following.includes(p.author?.uid);
            followBtn.textContent = isFollowing ? 'Siguiendo' : 'Seguir';
          });
        }
      } else {
        followBtn.style.display='none';
      }

      head.appendChild(av); head.appendChild(right); head.appendChild(followBtn);

      const title = document.createElement('div'); title.className='post-title'; title.textContent = p.title || '(sin t√≠tulo)';
      const desc = document.createElement('div'); desc.className='post-desc'; desc.textContent = p.desc || '';
      const body = document.createElement('div'); body.className='post-content'; body.innerHTML = p.bodyHtml || '';

      const tagsRow = document.createElement('div'); tagsRow.className='tag-row';
      (p.tags||[]).forEach(t=>{ const tag=document.createElement('span'); tag.className='tag'; tag.textContent='#'+t; tagsRow.appendChild(tag); });

      const yt = (p.media||[]).find(m=>m.type==='youtube' && m.videoId);
      if (yt){
        const fv = document.createElement('iframe'); fv.className='featured-video'; fv.src=`https://www.youtube.com/embed/${yt.videoId}`;
        fv.allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"; fv.allowFullscreen=true;
        card.appendChild(fv);
      }

      const gallery = document.createElement('div'); gallery.className='gallery';
      (p.media||[]).forEach(m=>{
        if (m.type==='image'){
          const img=document.createElement('img'); img.src=m.url; img.alt=p.title||'';
          img.addEventListener('click', ()=> openLightbox('image', m.url));
          gallery.appendChild(img);
        }
      });

      const actions = document.createElement('div'); actions.className='actions';
      const likeBtn = document.createElement('button'); likeBtn.className='action-btn'; likeBtn.textContent='Me gusta';
      const liked = u && (p.likedBy||[]).includes(u.uid); if (liked) likeBtn.classList.add('active');
      const counts = document.createElement('span'); counts.textContent = (p.likesCount||0) + ' likes';

      likeBtn.addEventListener('click', async ()=>{
        const cu = auth.currentUser; if (!cu){ alert('Inicia sesi√≥n para dar like.'); return; }
        const ref = firestore.collection('posts').doc(id);
        await firestore.runTransaction(async tx=>{
          const snap = await tx.get(ref); if (!snap.exists) return;
          const d = snap.data(); const likedBy = d.likedBy||[]; const has = likedBy.includes(cu.uid);
          const newLikedBy = has ? likedBy.filter(x=>x!==cu.uid) : [...likedBy, cu.uid];
          const delta = has ? -1 : 1;
          tx.update(ref, { likedBy: newLikedBy, likesCount: (d.likesCount||0)+delta });
        });
      });

      firestore.collection('posts').doc(id).onSnapshot(s=>{
        const d=s.data(); if(!d) return;
        counts.textContent = (d.likesCount||0)+' likes';
        if (auth.currentUser) {
          const isLiked = (d.likedBy||[]).includes(auth.currentUser.uid);
          likeBtn.classList.toggle('active', isLiked);
        }
      });

      const authorActions = document.createElement('div'); authorActions.className='author-actions';
      if (u && u.uid===p.author?.uid){
        const edit = document.createElement('button'); edit.className='btn-mini'; edit.textContent='Editar';
        const del = document.createElement('button'); del.className='btn-mini btn-danger'; del.textContent='Eliminar';
        edit.addEventListener('click', ()=> openPostEditModal(id, p));
        del.addEventListener('click', async ()=>{
          const ok = confirm('¬øEliminar publicaci√≥n?'); if (!ok) return;
          try{
            await firestore.collection('posts').doc(id).delete();
            await pushNotification(u.uid, `Eliminaste "${p.title||'(sin t√≠tulo)'}"`, { postId:id });
          }catch(e){ alert('Error eliminando: '+e.message); }
        });
        authorActions.appendChild(edit); authorActions.appendChild(del);
      }

      actions.appendChild(likeBtn);
      actions.appendChild(counts);
      actions.appendChild(authorActions);

      const commentsWrap = document.createElement('div'); commentsWrap.className='comments';
      const commentsTitle = document.createElement('h4'); commentsTitle.textContent='Comentarios';
      const commentsList = document.createElement('div'); commentsList.id = `comments-${id}`;
      const form = document.createElement('div'); form.className='comment-form';
      const cInput = document.createElement('input'); cInput.className='comment-input'; cInput.placeholder='Escribe un comentario‚Ä¶';
      const cSend = document.createElement('button'); cSend.className='comment-btn'; cSend.textContent='Comentar';
      form.appendChild(cInput); form.appendChild(cSend);

      cSend.addEventListener('click', async ()=>{
        const cu=auth.currentUser; if(!cu){ alert('Inicia sesi√≥n para comentar.'); return; }
        const text=cInput.value.trim(); if(!text) return;
        cSend.disabled=true;
        try{
          const docRef = await firestore.collection('posts').doc(id).collection('comments').add({
            text, parentId:null, likesCount:0, likedBy:[],
            author:{ uid:cu.uid, name:cu.displayName||cu.email||'Usuario', avatar:cu.photoURL||null },
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          if (p.author?.uid && p.author.uid!==cu.uid) {
            await pushNotification(p.author.uid, `${cu.displayName || 'Usuario'} coment√≥ en "${p.title||'(sin t√≠tulo)'}"`, { postId:id, commentId:docRef.id });
          }
          cInput.value='';
        }catch(e){ alert('Error al comentar: '+e.message); }
        cSend.disabled=false;
      });

      let fullComments=[];
      firestore.collection('posts').doc(id).collection('comments').orderBy('createdAt','asc').onSnapshot(cs=>{
        fullComments=[]; cs.forEach(c=> fullComments.push({ id:c.id, ...c.data() }));
        commentsList.innerHTML='';
        fullComments.filter(x=>!x.parentId).forEach(c=> commentsList.appendChild(makeCommentEl(id, p, c)));
      });

      function makeCommentEl(postId, postData, c){
        const item = document.createElement('div'); item.className='comment-item'; item.id = `comment-${c.id}`;
        const av = document.createElement('img'); av.className='comment-avatar'; av.src = c.author?.avatar || 'https://abs.twimg.com/sticky/default_profile_images/default_profile_normal.png';
        const box = document.createElement('div'); box.className='comment-box';
        const meta = document.createElement('div'); meta.className='comment-meta';
        let ct='‚Äî'; try{ if(c.createdAt?.toDate) ct=c.createdAt.toDate().toLocaleString(); }catch{}
        const left = document.createElement('div'); left.textContent = (c.author?.name||'Usuario') + ' ‚Ä¢ ' + ct;
        const right = document.createElement('div');
        meta.appendChild(left); meta.appendChild(right);
        const text = document.createElement('div'); text.className='comment-text'; text.textContent = c.text;
        const actions = document.createElement('div'); actions.className='comment-actions';
        const like = document.createElement('button'); like.className='comment-action'; like.textContent = `üëç ${c.likesCount||0}`;
        actions.appendChild(like);

        const cu = auth.currentUser;
        if (cu && c.author?.uid===cu.uid){
          const edit = document.createElement('button'); edit.className='comment-action'; edit.textContent='Editar';
          const del = document.createElement('button'); del.className='comment-action'; del.textContent='Eliminar';
          actions.appendChild(edit); actions.appendChild(del);

          edit.addEventListener('click', async ()=>{
            const newText = prompt('Editar comentario:', c.text);
            if (newText===null) return;
            const safe = newText.trim();
            try{ await firestore.collection('posts').doc(postId).collection('comments').doc(c.id).set({ text:safe }, { merge:true }); }
            catch(e){ alert('Error editando: '+e.message); }
          });

          del.addEventListener('click', async ()=>{
            const ok = confirm('¬øEliminar comentario?'); if (!ok) return;
            try{ await firestore.collection('posts').doc(postId).collection('comments').doc(c.id).delete(); }
            catch(e){ alert('Error eliminando: '+e.message); }
          });
        }

        like.addEventListener('click', async ()=>{
          const cu2 = auth.currentUser; if (!cu2){ alert('Inicia sesi√≥n.'); return; }
          const ref = firestore.collection('posts').doc(postId).collection('comments').doc(c.id);
          await firestore.runTransaction(async tx=>{
            const snap = await tx.get(ref); if (!snap.exists) return;
            const d = snap.data(); const likedBy = d.likedBy||[]; const has = likedBy.includes(cu2.uid);
            const newLikedBy = has ? likedBy.filter(x=>x!==cu2.uid) : [...likedBy, cu2.uid];
            const delta = has ? -1 : 1;
            tx.update(ref, { likedBy:newLikedBy, likesCount:(d.likesCount||0)+delta });
          });
        });

        box.appendChild(meta); box.appendChild(text); box.appendChild(actions);
        item.appendChild(av); item.appendChild(box);
        return item;
      }

      card.appendChild(head);
      card.appendChild(title);
      card.appendChild(desc);
      card.appendChild(body);
      if ((p.media||[]).some(m=>m.type==='image')) card.appendChild(gallery);
      card.appendChild(tagsRow);
      card.appendChild(actions);
      card.appendChild(commentsWrap);
      commentsWrap.appendChild(commentsTitle);
      commentsWrap.appendChild(commentsList);
      commentsWrap.appendChild(form);

      return card;
    }

    /* Edit modal */
    const postEditModal = document.getElementById('postEditModal');
    const closePostEdit = document.getElementById('closePostEdit');
    const editTitleInput = document.getElementById('editTitleInput');
    const editDescInput = document.getElementById('editDescInput');
    const editTagsInput = document.getElementById('editTagsInput');
    const editYoutubeInput = document.getElementById('editYoutubeInput');
    const editEditor = document.getElementById('editEditor');
    const savePostEditBtn = document.getElementById('savePostEditBtn');
    const cancelPostEditBtn = document.getElementById('cancelPostEditBtn');
    let editingPostId=null; let originalPostData=null;

    function openPostEditModal(id, p){
      editingPostId=id; originalPostData=p;
      editTitleInput.value=p.title||''; editDescInput.value=p.desc||'';
      editTagsInput.value=(p.tags||[]).join(', ');
      const yt=(p.media||[]).find(m=>m.type==='youtube');
      editYoutubeInput.value = yt ? `https://www.youtube.com/watch?v=${yt.videoId}` : '';
      editEditor.innerHTML = p.bodyHtml || '';
      show(postEditModal); lockBody();
    }
    function closePostEditModal(){ hide(postEditModal); unlockBody(); editingPostId=null; originalPostData=null; }
    closePostEdit.addEventListener('click', closePostEditModal);
    cancelPostEditBtn.addEventListener('click', closePostEditModal);
    postEditModal.addEventListener('click', (e)=>{ if(e.target===postEditModal){ closePostEditModal(); } });

    savePostEditBtn.addEventListener('click', async ()=>{
      const u=auth.currentUser; if(!u){ alert('Inicia sesi√≥n.'); return; }
      if (!editingPostId) return;
      const title=editTitleInput.value.trim();
      const desc=editDescInput.value.trim();
      const bodyHtml=editEditor.innerHTML.trim();
      const tags=editTagsInput.value.split(',').map(t=>t.trim().toLowerCase()).filter(Boolean);
      const ytId = extractYouTubeId(editYoutubeInput.value.trim());
      let media = (originalPostData.media||[]).filter(m=>m.type!=='youtube');
      if (ytId) media = [{ type:'youtube', videoId:ytId }, ...media];
      try{
        await firestore.collection('posts').doc(editingPostId).set({ title, desc, bodyHtml, tags, media }, { merge:true });
        await pushNotification(u.uid, `Editaste "${title||'(sin t√≠tulo)'}"`, { postId:editingPostId });
        closePostEditModal();
      }catch(e){ alert('Error guardando: '+e.message); }
    });

    /* Sidebar stats & lists */
    function renderSidebar(list){
      const topAuthors = document.getElementById('topAuthors');
      const topPosts = document.getElementById('topPosts');
      const topTags = document.getElementById('topTags');
      topAuthors.innerHTML=''; topPosts.innerHTML=''; topTags.innerHTML='';

      const authorMap = {};
      list.forEach(p=>{
        const uid = p.data.author?.uid || 'anon';
        authorMap[uid] = authorMap[uid] || { uid, name:p.data.author?.name||'Usuario', avatar:p.data.author?.avatar||null, likes:0, posts:0 };
        authorMap[uid].likes += (p.data.likesCount||0);
        authorMap[uid].posts += 1;
      });
      Object.values(authorMap).sort((a,b)=> b.likes-a.likes).slice(0,6).forEach(a=>{
        const row = document.createElement('div'); row.className='list-row';
        const left = document.createElement('div'); left.className='list-left';
        const av = document.createElement('img'); av.src = a.avatar || ('https://ui-avatars.com/api/?name='+encodeURIComponent(a.name));
        const txt = document.createElement('div'); txt.innerHTML = `<strong>${escapeHtml(a.name)}</strong><div style="color:var(--muted);font-size:12px">${a.posts} posts ‚Ä¢ ${a.likes} likes</div>`;
        left.appendChild(av); left.appendChild(txt); row.appendChild(left);
        topAuthors.appendChild(row);
      });

      const sortedPosts = [...list].sort((a,b)=> (b.data.likesCount||0)-(a.data.likesCount||0)).slice(0,6);
      sortedPosts.forEach(p=>{
        const row = document.createElement('div'); row.className='list-row';
        const left = document.createElement('div'); left.className='list-left';
        const av = document.createElement('img'); av.src = p.data.author?.avatar || ('https://ui-avatars.com/api/?name='+encodeURIComponent(p.data.author?.name||'Usuario'));
        const txt = document.createElement('div'); txt.innerHTML = `<strong>${escapeHtml(p.data.title||'(sin t√≠tulo)')}</strong><div style="color:var(--muted);font-size:12px">${p.data.likesCount||0} likes ‚Ä¢ ${escapeHtml(p.data.author?.name||'Usuario')}</div>`;
        left.appendChild(av); left.appendChild(txt); row.appendChild(left);
        topPosts.appendChild(row);
      });

      const tagCounts = {};
      list.forEach(p=> (p.data.tags||[]).forEach(t=> tagCounts[t]=(tagCounts[t]||0)+1 ));
      Object.entries(tagCounts).sort((a,b)=> b[1]-a[1]).slice(0,10).forEach(([t,c])=>{
        const row = document.createElement('div'); row.className='list-row';
        row.innerHTML = `<div class="list-left"><div><strong>#${escapeHtml(t)}</strong></div></div><div style="color:var(--muted)">${c}</div>`;
        topTags.appendChild(row);
      });
    }

    async function loadRightColumnStats(){
      const u=auth.currentUser; if(!u) return;
      const snap = await firestore.collection('posts').where('author.uid','==',u.uid).get();
      let totalPosts=0, totalLikes=0, donationFlag=false;
      snap.forEach(doc=>{ const d=doc.data(); totalPosts++; totalLikes+=(d.likesCount||0); donationFlag = donationFlag || d.donationEnabled===true; });
      document.getElementById('statPosts').textContent=totalPosts;
      document.getElementById('statLikes').textContent=totalLikes;
      document.getElementById('statDonation').textContent = (totalLikes>=10000 || donationFlag) ? 'ON' : 'OFF';
    }

    /* Dashboard simple */
    const openDashboard = document.getElementById('openDashboard');
    const openDashboardSide = document.getElementById('openDashboardSide');
    openDashboard?.addEventListener('click', ()=> alert('Dashboard: revisa tus m√©tricas en la barra lateral.'));
    openDashboardSide?.addEventListener('click', ()=> alert('Dashboard: revisa tus m√©tricas en la barra lateral.'));

    /* Lightbox */
    const lightbox = document.getElementById('lightbox');
    const lightboxContent = document.getElementById('lightboxContent');
    const lightboxClose = document.getElementById('lightboxClose');
    function openLightbox(type, url){
      lightboxContent.innerHTML='';
      if (type==='image'){ const img=document.createElement('img'); img.src=url; lightboxContent.appendChild(img); }
      else { const vid=document.createElement('video'); vid.src=url; vid.controls=true; vid.autoplay=true; lightboxContent.appendChild(vid); }
      show(lightbox); lockBody();
    }
    lightboxClose.addEventListener('click', ()=>{ hide(lightbox); unlockBody(); });
    lightbox.addEventListener('click', (e)=>{ if(e.target===lightbox){ hide(lightbox); unlockBody(); } });

    /* Mobile tabs */
    const tabHome = document.getElementById('tabHome');
    const tabCompose = document.getElementById('tabCompose');
    const tabNotif = document.getElementById('tabNotif');
    const tabProfile = document.getElementById('tabProfile');

    function activateTab(btn){
      document.querySelectorAll('.mobile-tabs button').forEach(b=> b.classList.remove('active'));
      btn.classList.add('active');
    }
    tabHome.addEventListener('click', ()=>{ activateTab(tabHome); window.scrollTo({ top:0, behavior:'smooth' }); });
    tabCompose.addEventListener('click', ()=>{ activateTab(tabCompose); if(!auth.currentUser){ alert('Inicia sesi√≥n para publicar.'); return; } show(composerModal); lockBody(); });
    tabNotif.addEventListener('click', ()=>{ activateTab(tabNotif); notifPanel.style.display='block'; });
    tabProfile.addEventListener('click', async ()=>{
      activateTab(tabProfile);
      if (!auth.currentUser){
        const provider = new firebase.auth.GoogleAuthProvider();
        try{ await auth.signInWithPopup(provider); }catch(e){ alert('Error al iniciar sesi√≥n: '+e.message); }
      } else {
        alert('Perfil: usa el Dashboard para ver tu actividad.');
      }
    });

    /* Inline post viewer from notifications */
    function openPostViewInline(postId, commentId=null){
      const found = postsCache.find(p=>p.id===postId);
      if (!found) return;
      window.scrollTo({ top:0, behavior:'smooth' });
      postsContainer.innerHTML='';
      postsContainer.appendChild(renderPostCard(found.id, found.data));
      if (commentId){
        setTimeout(()=>{
          const el = document.getElementById(`comment-${commentId}`);
          if (el) el.scrollIntoView({ behavior:'smooth', block:'center' });
        }, 300);
      }
    }

    /* Auth state updates */
    auth.onAuthStateChanged(async user => {
      if (user) {
        googleBtn.style.display = 'none';
        userChip.style.display = 'inline-flex';
        userName.textContent = user.displayName || user.email;
        const av = user.photoURL || 'https://abs.twimg.com/sticky/default_profile_images/default_profile_normal.png';
        userAvatar.src = av;
        document.getElementById('profileAvatar').src = av;
        document.getElementById('profileName').textContent = user.displayName || 'Usuario';
        document.getElementById('profileEmail').textContent = user.email || '';
      } else {
        googleBtn.style.display = 'inline-flex';
        userChip.style.display = 'none';
        document.getElementById('profileAvatar').src = 'https://abs.twimg.com/sticky/default_profile_images/default_profile_normal.png';
        document.getElementById('profileName').textContent = '';
        document.getElementById('profileEmail').textContent = '';
      }
      await refreshFollowing();
      renderFeed();
      renderSidebar(postsCache);
      loadRightColumnStats();
      subscribeMyNotifications();
    });
  </script>
</body>
</html>
