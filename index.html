<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>SIN NADA QUE OCULTAR RD ‚Äî Informaci√≥n libre y sin sensura</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tipograf√≠as -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
  <!-- Firebase (compat para simplicidad) -->
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>
  <style>
    :root{
      --bg:#f5f8fc; --surface:#ffffff; --text:#0a1f36; --muted:#64748b;
      --brand:#1d6df2; --brand-2:#5aa4ff; --border:#d8e6f7;
      --chip:#eaf3ff; --shadow:0 12px 30px rgba(29,109,242,.12);
      --like:#ef4444; --comment:#1f7ae0;
    }
    *{box-sizing:border-box}
    body{margin:0; background:var(--bg); color:var(--text); font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;}
    a{text-decoration:none; color:inherit}
    img{max-width:100%; display:block}

    header{
      position:sticky; top:0; z-index:90;
      background:linear-gradient(180deg, rgba(245,249,255,.98), rgba(245,249,255,.92));
      backdrop-filter: blur(8px);
      border-bottom:1px solid var(--border);
    }
    .topbar{
      max-width:1240px; margin:0 auto; padding:.75rem 1rem;
      display:grid; grid-template-columns:auto 1fr auto auto; align-items:center; gap:1rem;
    }
    .brand{display:flex; align-items:center; gap:.7rem}
    .logo-img{
      width:42px; height:42px; border-radius:10px; border:1px solid var(--border);
      background:#fff; overflow:hidden; box-shadow:var(--shadow);
    }
    .brand-block{display:flex; flex-direction:column; line-height:1.1;}
    .site-title{font-family:"Playfair Display",serif; font-size:1.3rem; margin:0;}
    .site-slogan{font-size:.85rem; color:#174b8a; font-weight:700; letter-spacing:.02em}
    .btn{
      padding:.5rem .85rem; border-radius:10px; border:1px solid var(--border);
      background:#fff; color:#0a1f36; font-weight:600; cursor:pointer; transition:.2s ease;
      box-shadow:var(--shadow);
    }
    .btn.primary{background:var(--brand); border-color:var(--brand); color:#fff}
    .btn:hover{transform:translateY(-1px)}
    .avatar{width:34px; height:34px; border-radius:50%; overflow:hidden; border:1px solid var(--border); background:#eef6ff}

    .ticker-wrap{display:grid; grid-template-columns:auto 1fr auto; gap:.6rem; align-items:center; border-left:1px solid var(--border); padding-left:.75rem;}
    .ticker-label{font-weight:700; color:var(--brand);}
    .ticker{position:relative; overflow:hidden; height:32px;}
    .ticker-track{display:flex; gap:1rem; align-items:center; position:absolute; left:0; top:0; will-change: transform;}
    .ticker-item{display:flex; align-items:center; gap:.4rem; background:var(--chip); border:1px solid var(--border); color:#174b8a; padding:.25rem .6rem; border-radius:999px; white-space:nowrap; box-shadow:var(--shadow); cursor:pointer;}
    .ticker-item .tag{color:#174b8a; font-weight:700}

    main{max-width:1240px; margin:1rem auto; padding:0 1rem; display:grid; grid-template-columns:1.8fr 1fr; gap:1.2rem;}
    @media(max-width:980px){main{grid-template-columns:1fr} .ticker-wrap{display:none}}

    .forum{display:grid; gap:1rem}
    .thread{
      display:grid; grid-template-columns:56px 1fr auto; gap:1rem; align-items:start;
      background:var(--surface); border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow); padding:.95rem 1rem;
      transition:.2s ease;
    }
    .thread:hover{transform:translateY(-2px)}
    .thread .avatar{width:56px; height:56px; border-radius:12px; background:#eef6ff; border-color:#e3eeff}
    .title-row{display:flex; align-items:center; gap:.5rem}
    .thread .title{font-weight:800; font-size:1.08rem}
    .badge{background:linear-gradient(135deg, var(--chip), #fff); color:#174b8a; border:1px solid var(--border); font-weight:700; font-size:.75rem; padding:.18rem .55rem; border-radius:999px;}
    .thread .meta{display:flex; flex-wrap:wrap; gap:.6rem; color:#64748b; font-size:.9rem; margin:.2rem 0}
    .thread .excerpt{color:#1e3a5f; font-size:.95rem; line-height:1.5; margin:.25rem 0}
    .thumb{width:140px; height:90px; border-radius:12px; overflow:hidden; border:1px solid var(--border); background:#f1f6ff; box-shadow:0 6px 14px rgba(0,0,0,.06);}
    .thumb img{width:100%; height:100%; object-fit:cover}
    .stats{display:grid; gap:.4rem; justify-items:end; color:#153a5f; font-weight:700; font-size:.9rem;}
    .stat{display:flex; align-items:center; gap:.4rem; padding:.3rem .6rem; border-radius:999px; border:1px solid var(--border); background:#fff;}
    .stat.like{color:#b42323}
    .stat.comment{color:#1f7ae0}
    .stat.updated{color:#0a1f36}

    .sidebar .module{background:var(--surface); border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow); margin-bottom:1rem;}
    .module header{padding:.8rem 1rem; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center}
    .module header h3{margin:0; font-size:1rem;}
    .module .body{padding:.85rem 1rem; display:grid; gap:.6rem}
    .search-input{width:100%; padding:.6rem .8rem; border-radius:10px; border:1px solid var(--border)}
    .module .item{display:grid; gap:.2rem}
    .module .item .title{font-weight:700}
    .module .item .meta{font-size:.88rem; color:#64748b}

    .detail{position:fixed; inset:0; display:none; background:rgba(0,0,0,.45); backdrop-filter:blur(8px); z-index:95; align-items:center; justify-content:center}
    .modal{width:min(1020px,95vw); max-height:90vh; overflow:auto; background:var(--surface); border:1px solid var(--border); border-radius:20px; box-shadow:var(--shadow)}
    .modal header{position:sticky; top:0; background:var(--surface); border-bottom:1px solid var(--border); padding:.95rem 1.1rem; display:flex; justify-content:space-between; align-items:center}
    .modal .body{padding:1.1rem; display:grid; gap:.9rem}
    .modal .cover img{max-width:100%; margin:0 auto; display:block; border-radius:14px}
    .post-html{line-height:1.75; color:#153a5f}
    .post-html img{max-width:100%; margin:1rem auto; display:block; border-radius:14px}

    .composer{position:fixed; inset:0; display:none; background:rgba(0,0,0,.45); backdrop-filter:blur(8px); z-index:98; align-items:center; justify-content:center}
    .composer .modal{width:min(960px,95vw); max-height:92vh; overflow:auto}
    .editor{display:grid; gap:.7rem; padding:1rem}
    .toolbar{display:flex; flex-wrap:wrap; gap:.45rem}
    .tool{padding:.38rem .6rem; border-radius:8px; border:1px solid var(--border); background:#fff; cursor:pointer; font-weight:700; color:#164b8a; font-size:.85rem}
    .editor input[type="text"], .editor textarea{width:100%; padding:.6rem .75rem; border-radius:10px; border:1px solid var(--border)}
    .rte{min-height:160px; padding:.6rem .75rem; border-radius:10px; border:1px solid var(--border); background:#fff}
    .preview{display:flex; gap:.6rem; flex-wrap:wrap}
    .preview .ph{width:120px; height:80px; border:1px solid var(--border); border-radius:8px; overflow:hidden; background:#eef6ff}
    .preview .ph img, .preview .ph video{width:100%; height:100%; object-fit:cover}

    .composer-actions{display:flex; justify-content:flex-end; gap:.6rem; padding:0 1rem 1rem}
    .skeleton{position:relative; overflow:hidden; background:#eef6ff; border:1px solid var(--border); border-radius:12px}
    .skeleton::after{content:""; position:absolute; inset:0; background:linear-gradient(90deg, transparent, rgba(255,255,255,.6), transparent); animation: shimmer 1.8s infinite;}
    @keyframes shimmer{from{transform:translateX(-100%)}to{transform:translateX(100%)}}
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <div class="brand">
        <div class="logo-img">
          <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjS8LXAzi1Yiook-sOoY1qALICMCqeaZIYKCGeGogvvyhP85GNNKH2nPshVJBRtdggNYOAB4JYP10iMRH7FD4887JXS9yiaY6g0dtRqkgj9Vmbuql5VqpzJ0gwUxsMzERwBlKxHbwUTFIwtBWJVPT-Du-HSg8gsbkIz4cl32AWD9fjbtm9p3FDnq4_Wpdc/s320/gg843.png" alt="Logo" style="width:100%;height:100%;object-fit:cover">
        </div>
        <div class="brand-block">
          <h1 class="site-title">SIN NADA QUE OCULTAR RD</h1>
          <div class="site-slogan">INFORMACI√ìN LIBRE Y SIN SENSURA</div>
        </div>
      </div>

      <div class="ticker-wrap">
        <span class="ticker-label">√öltima hora</span>
        <div id="ticker" class="ticker" title="Pasa el mouse para pausar"></div>
        <div class="ticker-controls" style="display:flex; gap:.35rem">
          <button id="prevTicker" class="btn" aria-label="Anterior">‚óÄ</button>
          <button id="nextTicker" class="btn" aria-label="Siguiente">‚ñ∂</button>
        </div>
      </div>

      <div class="user" style="display:flex; align-items:center; gap:.6rem">
        <div id="avatar" class="avatar"></div>
        <button id="loginBtn" class="btn primary">Iniciar sesi√≥n con Google</button>
        <button id="publishBtn" class="btn">Crear hilo</button>
      </div>
    </div>
  </header>

  <main>
    <section id="forum" class="forum">
      <article class="thread">
        <div class="avatar skeleton"></div>
        <div>
          <div class="title-row">
            <div class="title">Cargando hilos‚Ä¶</div>
            <span class="badge">#Noticias</span>
          </div>
          <div class="meta">‚Äî</div>
          <div class="excerpt">‚Äî</div>
        </div>
        <div class="stats">
          <div class="stat like"><span>‚ù§</span><span>0</span></div>
          <div class="stat comment"><span>üí¨</span><span>0</span></div>
          <div class="stat updated"><span>‚è±</span><span>‚Äî</span></div>
        </div>
      </article>
    </section>

    <aside class="sidebar">
      <div class="module">
        <header><h3>Buscar</h3><span class="meta">T√≠tulos y descripci√≥n</span></header>
        <div class="body"><input id="searchInput" class="search-input" type="text" placeholder="Escribe para buscar‚Ä¶"></div>
      </div>

      <div class="module">
        <header><h3>Tendencias</h3><span class="meta">√öltima actualizaci√≥n</span></header>
        <div id="modTrends" class="body">
          <div class="item"><div class="title">Cargando‚Ä¶</div></div>
        </div>
      </div>
    </aside>
  </main>

  <!-- Modal lectura -->
  <div id="detail" class="detail">
    <div class="modal">
      <header>
        <div class="meta"><span id="detailAuthor">‚Äî</span> ‚Ä¢ <span id="detailDate">‚Äî</span></div>
        <button id="closeDetail" class="btn">Cerrar</button>
      </header>
      <div class="body">
        <h2 id="detailTitle" class="title"></h2>
        <div class="cover" id="detailCover"></div>
        <article id="detailHtml" class="post-html"></article>

        <div class="module" style="margin-top:.4rem">
          <header><h3>Respuestas</h3></header>
          <div id="commentsList" class="body"></div>
        </div>

        <div class="module" style="margin-top:.4rem">
          <header><h3>Responder</h3><span class="meta" id="composerHint">Inicia sesi√≥n para comentar</span></header>
          <div class="body">
            <div class="toolbar">
              <button class="tool" data-cmd="bold"><b>Negrita</b></button>
              <button class="tool" data-cmd="italic"><i>Cursiva</i></button>
              <button class="tool" data-cmd="underline"><u>Subrayado</u></button>
              <button class="tool" data-cmd="insertUnorderedList">‚Ä¢ Lista</button>
              <button class="tool" id="linkBtn">Enlace</button>
              <label class="tool" for="commentImage">Imagen</label>
              <input id="commentImage" type="file" accept="image/*" style="display:none">
              <label class="tool" for="commentVideo">Video</label>
              <input id="commentVideo" type="file" accept="video/*" style="display:none">
            </div>
            <div id="commentEditor" class="rte" contenteditable="true" placeholder="Escribe tu respuesta‚Ä¶"></div>
            <div class="preview" id="commentPreview"></div>
            <div class="composer-actions">
              <button id="publishComment" class="btn primary">Publicar respuesta</button>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Modal crear hilo -->
  <div id="composer" class="composer">
    <div class="modal">
      <header style="position:sticky; top:0; padding:.85rem 1rem; background:var(--surface); border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center">
        <strong>Crear hilo</strong>
        <button id="closeComposer" class="btn">Cerrar</button>
      </header>
      <div class="editor">
        <input id="pubTitle" type="text" placeholder="T√≠tulo del hilo">
        <textarea id="pubDescription" rows="3" placeholder="Descripci√≥n breve"></textarea>

        <div class="toolbar" id="pubToolbar">
          <button class="tool" data-cmd="bold"><b>Negrita</b></button>
          <button class="tool" data-cmd="italic"><i>Cursiva</i></button>
          <button class="tool" data-cmd="underline"><u>Subrayado</u></button>
          <button class="tool" data-cmd="insertUnorderedList">‚Ä¢ Lista</button>
          <button class="tool" id="pubLinkBtn">Enlace</button>
          <label class="tool" for="pubImage">Imagen</label>
          <input id="pubImage" type="file" accept="image/*" style="display:none">
          <label class="tool" for="pubVideo">Video</label>
          <input id="pubVideo" type="file" accept="video/*" style="display:none">
        </div>
        <div id="pubEditor" class="rte" contenteditable="true" placeholder="Contenido del hilo‚Ä¶"></div>
        <div class="preview" id="pubPreview"></div>
      </div>
      <div class="composer-actions">
        <button id="submitPost" class="btn primary">Publicar</button>
      </div>
    </div>
  </div>

  <script>
    // ===== Configura tus credenciales (si tienes Firebase y Cloudinary) =====
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyB5mGkfLPYDUukAw_XjJUcUPVuhj6_gk0A",
      authDomain: "sin-nada-que-ocultar-rd.firebaseapp.com",
      projectId: "sin-nada-que-ocultar-rd",
      storageBucket: "sin-nada-que-ocultar-rd.firebasestorage.app",
      messagingSenderId: "1054622320892",
      appId: "1:1054622320892:web:dd3412dcb3ce781e0f2f79"
    };
    const CLOUD_NAME = "REEMPLAZA_AQUI";
    const UPLOAD_PRESET = "REEMPLAZA_AQUI";

    // ===== Blogger fallback (si no hay Firebase datos) =====
    const BLOGGER_API_KEY = "AIzaSyCARk0pc3s7y3VLUTi6LNuSpP-FD2l7OtI";
    const BLOG_ID = "5213119795675357751";
    const BLOGGER_BASE = "https://www.googleapis.com/blogger/v3";

    let db = null, auth = null;
    let currentUser = null; // { uid, displayName, photoURL }
    let tickerPaused = false, tickerOffset = 0;

    const fmtDate = v => {
      try{
        const d = v instanceof Date ? v : (v?.toDate ? v.toDate() : new Date(v));
        return d.toLocaleString("es-DO",{dateStyle:"medium",timeStyle:"short"});
      }catch{return "‚Äî";}
    };
    const strip = html => { const tmp=document.createElement("div"); tmp.innerHTML=html||""; return tmp.textContent || tmp.innerText || ""; };
    const pickFirstImage = html => { const div=document.createElement("div"); div.innerHTML=html||""; const img=div.querySelector("img"); return img?img.src:null; };
    const removeFirstImage = html => { const d=document.createElement("div"); d.innerHTML=html||""; const im=d.querySelector("img"); if(im) im.remove(); return d.innerHTML; };
    const canInteract = () => !!currentUser;

    // ===== Inicializa Firebase si hay config v√°lida (apiKey no vac√≠o) =====
    const firebaseReady = FIREBASE_CONFIG.apiKey && FIREBASE_CONFIG.apiKey !== "REEMPLAZA_AQUI";
    if (firebaseReady) {
      firebase.initializeApp(FIREBASE_CONFIG);
      auth = firebase.auth();
      db = firebase.firestore();
      auth.onAuthStateChanged(user => {
        currentUser = user ? { uid:user.uid, displayName:user.displayName, photoURL:user.photoURL } : null;
        renderAvatar();
      });
      document.getElementById('loginBtn').addEventListener('click', async () => {
        const provider = new firebase.auth.GoogleAuthProvider();
        try{ await auth.signInWithPopup(provider); }catch(e){ alert("No se pudo iniciar sesi√≥n: " + e.message); }
      });
    } else {
      // Si no hay Firebase configurado, oculta el bot√≥n publicar (no hay persistencia)
      document.getElementById('publishBtn').addEventListener('click', () => {
        alert("Configura Firebase para poder publicar hilos.");
      });
      document.getElementById('loginBtn').addEventListener('click', () => {
        alert("Configura Firebase para iniciar sesi√≥n.");
      });
    }

    function renderAvatar(){
      const av = document.getElementById('avatar');
      av.innerHTML = currentUser?.photoURL ? `<img src="${currentUser.photoURL}" alt="${currentUser.displayName}" style="width:100%;height:100%;object-fit:cover">` : "";
    }

    async function uploadToCloudinary(file){
      if (!CLOUD_NAME || CLOUD_NAME === "REEMPLAZA_AQUI") throw new Error("Configura Cloudinary");
      const url = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`;
      const form = new FormData();
      form.append("file", file);
      form.append("upload_preset", UPLOAD_PRESET);
      const res = await fetch(url, { method:"POST", body:form });
      if(!res.ok) throw new Error("Error subiendo a Cloudinary");
      const data = await res.json();
      return data.secure_url;
    }

    // ===== Ticker =====
    async function renderTickerFromFirestore(){
      const ticker = document.getElementById('ticker');
      ticker.innerHTML = "";
      const track = document.createElement('div'); track.className = "ticker-track";
      const snap = await db.collection("posts").orderBy("updatedAt","desc").limit(30).get();
      snap.forEach(doc => {
        const p = doc.data();
        const tag = p.tag || "Noticias";
        const item = document.createElement('div');
        item.className = "ticker-item";
        item.innerHTML = `<span class="tag">#${tag}</span><span>${p.title}</span>`;
        item.addEventListener('click', () => openDetailCustom(doc.id, p));
        track.appendChild(item);
      });
      ticker.appendChild(track);
      startTicker(track);
    }
    async function renderTickerFromBlogger(items){
      const ticker = document.getElementById('ticker');
      ticker.innerHTML = "";
      const track = document.createElement('div'); track.className = "ticker-track";
      items.slice(0,30).forEach(p => {
        const tag = (p.labels && p.labels.length) ? p.labels[0] : "Noticias";
        const item = document.createElement('div');
        item.className = "ticker-item";
        item.innerHTML = `<span class="tag">#${tag}</span><span>${p.title}</span>`;
        item.addEventListener('click', () => openDetailBlogger(p));
        track.appendChild(item);
      });
      ticker.appendChild(track);
      startTicker(track);
    }
    function startTicker(track){
      let tickerOffset = 0;
      const speed = 0.22;
      function step(){
        if(!tickerPaused){
          tickerOffset -= speed;
          track.style.transform = `translateX(${tickerOffset}px)`;
          const first = track.firstElementChild;
          if(first){
            const w = first.getBoundingClientRect().width + 16;
            if (Math.abs(tickerOffset) > w){
              track.appendChild(first);
              tickerOffset += w;
            }
          }
        }
        requestAnimationFrame(step);
      }
      requestAnimationFrame(step);
      document.getElementById('ticker').addEventListener('mouseenter', () => { tickerPaused = true; });
      document.getElementById('ticker').addEventListener('mouseleave', () => { tickerPaused = false; });
      document.getElementById('prevTicker').onclick = () => {
        const last = track.lastElementChild; if(last){ track.insertBefore(last, track.firstElementChild); }
      };
      document.getElementById('nextTicker').onclick = () => {
        const first = track.firstElementChild; if(first){ track.appendChild(first); }
      };
    }

    // ===== Feed Forum =====
    async function renderForumFromFirestore(snap){
      const forum = document.getElementById('forum');
      forum.innerHTML = "";
      if (snap.empty) {
        forum.innerHTML = `<article class="thread"><div class="title-row"><div class="title">No hay hilos a√∫n</div></div><div class="excerpt">Publica el primero.</div></article>`;
        return;
      }
      for (const doc of snap.docs) {
        const p = doc.data();
        const cover = p.coverUrl || pickFirstImage(p.contentHtml);
        const tag = p.tag || "Noticias";
        const excerpt = strip(p.description || p.contentHtml || "").slice(0, 180) + ((p.description || p.contentHtml || "").length > 180 ? "‚Ä¶" : "");
        const el = document.createElement('article');
        el.className = "thread";
        el.innerHTML = `
          <div class="avatar">${cover ? `<img src="${cover}" alt="" style="width:100%;height:100%;object-fit:cover;border-radius:12px">` : ""}</div>
          <div>
            <div class="title-row">
              <a href="#" class="title">${p.title}</a>
              <span class="badge">#${tag}</span>
            </div>
            <div class="meta"><span>${p.author?.name || "Redacci√≥n"}</span> ‚Ä¢ <span>${fmtDate(p.createdAt)}</span></div>
            <div class="excerpt">${excerpt}</div>
            <div class="thumb">${cover ? `<img src="${cover}" alt="${strip(p.title)}">` : ""}</div>
          </div>
          <div class="stats">
            <div class="stat like" data-id="${doc.id}">
              <span>‚ù§</span><span class="count">${p.likesCount || 0}</span>
            </div>
            <div class="stat comment" data-id="${doc.id}">
              <span>üí¨</span><span class="count">0</span>
            </div>
            <div class="stat updated"><span>‚è±</span><span>${fmtDate(p.updatedAt || p.createdAt)}</span></div>
          </div>
        `;
        el.querySelector('.title').addEventListener('click', (e) => { e.preventDefault(); openDetailCustom(doc.id, p); });
        const likeEl = el.querySelector('.stat.like');
        likeEl.addEventListener('click', async () => {
          if(!canInteract()){ alert("Inicia sesi√≥n para dar like."); return; }
          const likeDoc = db.collection("posts").doc(doc.id).collection("likes").doc(currentUser.uid);
          const exists = await likeDoc.get();
          if(exists.exists){
            await likeDoc.delete();
            await db.collection("posts").doc(doc.id).update({ likesCount: firebase.firestore.FieldValue.increment(-1) });
          }else{
            await likeDoc.set({ uid: currentUser.uid, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
            await db.collection("posts").doc(doc.id).update({ likesCount: firebase.firestore.FieldValue.increment(1) });
          }
          // refresca contador
          const updated = await db.collection("posts").doc(doc.id).get();
          likeEl.querySelector('.count').textContent = updated.data().likesCount || 0;
        });
        forum.appendChild(el);
        // conteo de comentarios
        const cSnap = await db.collection("posts").doc(doc.id).collection("comments").get();
        const cEl = document.querySelector(`.stat.comment[data-id="${doc.id}"] .count`);
        if (cEl) cEl.textContent = cSnap.size;
      }
    }

    async function renderForumFromBlogger(items){
      const forum = document.getElementById('forum');
      forum.innerHTML = "";
      items.forEach(p => {
        const cover = pickFirstImage(p.content);
        const tag = (p.labels && p.labels.length) ? p.labels[0] : "Noticias";
        const excerpt = strip(p.content || "").slice(0, 180) + ((p.content || "").length > 180 ? "‚Ä¶" : "");
        const el = document.createElement('article');
        el.className = "thread";
        el.innerHTML = `
          <div class="avatar">${cover ? `<img src="${cover}" alt="" style="width:100%;height:100%;object-fit:cover;border-radius:12px">` : ""}</div>
          <div>
            <div class="title-row">
              <a href="#" class="title">${p.title}</a>
              <span class="badge">#${tag}</span>
            </div>
            <div class="meta"><span>${p.author?.displayName || "Redacci√≥n"}</span> ‚Ä¢ <span>${fmtDate(p.published)}</span></div>
            <div class="excerpt">${excerpt}</div>
            <div class="thumb">${cover ? `<img src="${cover}" alt="${strip(p.title)}">` : ""}</div>
          </div>
          <div class="stats">
            <div class="stat like" title="Inicia sesi√≥n para dar like"><span>‚ù§</span><span class="count">0</span></div>
            <div class="stat comment" title="Inicia sesi√≥n para comentar"><span>üí¨</span><span class="count">0</span></div>
            <div class="stat updated"><span>‚è±</span><span>${fmtDate(p.updated)}</span></div>
          </div>
        `;
        el.querySelector('.title').addEventListener('click', (e) => { e.preventDefault(); openDetailBlogger(p); });
        forum.appendChild(el);
      });
    }

    // ===== Tendencias =====
    function renderTrendsFromFirestore(snap){
      const mod = document.getElementById('modTrends');
      mod.innerHTML = "";
      snap.docs.slice(0, 12).forEach(doc => {
        const p = doc.data();
        const row = document.createElement('div');
        row.className = "item";
        row.innerHTML = `<a href="#" class="title">${p.title}</a><div class="meta">${fmtDate(p.updatedAt || p.createdAt)} ‚Ä¢ #${p.tag || "Noticias"}</div>`;
        row.querySelector('.title').addEventListener('click', (e) => { e.preventDefault(); openDetailCustom(doc.id, p); });
        mod.appendChild(row);
      });
    }
    function renderTrendsFromBlogger(items){
      const mod = document.getElementById('modTrends');
      mod.innerHTML = "";
      items.slice(0, 12).forEach(p => {
        const row = document.createElement('div');
        row.className = "item";
        row.innerHTML = `<a href="#" class="title">${p.title}</a><div class="meta">${fmtDate(p.updated)} ‚Ä¢ ${(p.labels || []).map(l => `#${l}`).join(" ")}</div>`;
        row.querySelector('.title').addEventListener('click', (e) => { e.preventDefault(); openDetailBlogger(p); });
        mod.appendChild(row);
      });
    }

    // ===== B√∫squeda =====
    document.getElementById('searchInput').addEventListener('input', async (e) => {
      const q = e.target.value.trim().toLowerCase();
      if (db) {
        if(!q){ const snap = await db.collection("posts").orderBy("updatedAt","desc").limit(50).get(); renderForumFromFirestore(snap); return; }
        const snap = await db.collection("posts").orderBy("title").startAt(q).endAt(q + '\uf8ff').limit(30).get();
        renderForumFromFirestore(snap);
      } else {
        // Blogger
        const url = `${BLOGGER_BASE}/blogs/${BLOG_ID}/posts?key=${BLOGGER_API_KEY}&fetchBodies=true&maxResults=50&orderBy=UPDATED`;
        const res = await fetch(url); const data = await res.json();
        let items = data.items || [];
        if(q){ items = items.filter(p => ((p.title||"")+strip(p.content||"")).toLowerCase().includes(q)); }
        renderForumFromBlogger(items);
      }
    });

    // ===== Detalle (Firestore) =====
    async function openDetailCustom(postId, postData){
      document.getElementById('detailTitle').textContent = postData.title;
      document.getElementById('detailAuthor').textContent = postData.author?.name || "Redacci√≥n";
      document.getElementById('detailDate').textContent = fmtDate(postData.createdAt);
      const cover = postData.coverUrl || pickFirstImage(postData.contentHtml);
      document.getElementById('detailCover').innerHTML = cover ? `<img src="${cover}" alt="${strip(postData.title)}">` : "";
      document.getElementById('detailHtml').innerHTML = removeFirstImage(postData.contentHtml);

      const list = document.getElementById('commentsList');
      list.innerHTML = `<div class="meta">Cargando respuestas‚Ä¶</div>`;
      const snap = await db.collection("posts").doc(postId).collection("comments").orderBy("createdAt","desc").get();
      list.innerHTML = "";
      if (snap.empty) {
        list.innerHTML = `<div class="meta">S√© el primero en responder.</div>`;
      } else {
        snap.forEach(c => {
          const d = c.data();
          const item = document.createElement('div');
          item.className = "item";
          item.innerHTML = `<div class="title">${d.author?.name || "An√≥nimo"} ‚Ä¢ ${fmtDate(d.createdAt)}</div><div class="meta">${strip(d.html).slice(0, 200)}</div>`;
          list.appendChild(item);
        });
      }

      document.getElementById('detail').style.display = "flex";

      // comentar
      document.getElementById('publishComment').onclick = async () => {
        if(!canInteract()){ document.getElementById('composerHint').textContent = "Inicia sesi√≥n para publicar"; return; }
        const html = document.getElementById('commentEditor').innerHTML.trim();
        if(!html){ document.getElementById('composerHint').textContent = "La respuesta no puede estar vac√≠a"; return; }
        try{
          await db.collection("posts").doc(postId).collection("comments").add({
            html,
            author: { uid: currentUser.uid, name: currentUser.displayName, photo: currentUser.photoURL },
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          document.getElementById('composerHint').textContent = "Publicado";
          document.getElementById('commentEditor').innerHTML = "";
          document.getElementById('commentPreview').innerHTML = "";
          const snap2 = await db.collection("posts").doc(postId).collection("comments").orderBy("createdAt","desc").get();
          list.innerHTML = "";
          snap2.forEach(c => {
            const d = c.data();
            const item = document.createElement('div');
            item.className = "item";
            item.innerHTML = `<div class="title">${d.author?.name || "An√≥nimo"} ‚Ä¢ ${fmtDate(d.createdAt)}</div><div class="meta">${strip(d.html).slice(0, 200)}</div>`;
            list.appendChild(item);
          });
        }catch(e){
          document.getElementById('composerHint').textContent = "Error al publicar";
          console.error(e);
        }
      };

      bindToolbar(document.querySelector('#detail .toolbar'), document.getElementById('commentEditor'), document.getElementById('commentPreview'));
    }

    // ===== Detalle (Blogger fallback) =====
    async function openDetailBlogger(p){
      document.getElementById('detailTitle').textContent = p.title;
      document.getElementById('detailAuthor').textContent = p.author?.displayName || "Redacci√≥n";
      document.getElementById('detailDate').textContent = fmtDate(p.published);
      const cover = pickFirstImage(p.content);
      document.getElementById('detailCover').innerHTML = cover ? `<img src="${cover}" alt="${strip(p.title)}">` : "";
      document.getElementById('detailHtml').innerHTML = removeFirstImage(p.content);
      document.getElementById('commentsList').innerHTML = `<div class="meta">Comentarios disponibles al integrar Firebase.</div>`;
      document.getElementById('detail').style.display = "flex";
    }

    document.getElementById('closeDetail').addEventListener('click', () => { document.getElementById('detail').style.display = "none"; });
    document.getElementById('detail').addEventListener('click', (e) => { if(e.target.id==='detail') document.getElementById('detail').style.display="none"; });

    // ===== Editor enriquecido =====
    function bindToolbar(toolbarRoot, editorRoot, previewRoot){
      toolbarRoot.querySelectorAll('.tool[data-cmd]').forEach(btn => {
        btn.addEventListener('click', () => {
          document.execCommand(btn.getAttribute('data-cmd'), false, null);
          editorRoot.focus();
        });
      });
      const linkBtn = toolbarRoot.querySelector('#pubLinkBtn') || toolbarRoot.querySelector('#linkBtn');
      if (linkBtn) {
        linkBtn.addEventListener('click', () => {
          const url = prompt("URL del enlace:");
          if (url) document.execCommand('createLink', false, url);
        });
      }
      const imgInput = toolbarRoot.parentElement.querySelector('input[type="file"][accept^="image"]');
      const vidInput = toolbarRoot.parentElement.querySelector('input[type="file"][accept^="video"]');
      if (imgInput && previewRoot) {
        imgInput.addEventListener('change', async () => {
          for(const f of imgInput.files){
            const ph = document.createElement('div'); ph.className = 'ph';
            ph.innerHTML = `<div class="meta">Subiendo‚Ä¶</div>`;
            previewRoot.appendChild(ph);
            try{
              const url = await uploadToCloudinary(f);
              ph.innerHTML = `<img src="${url}" alt="">`;
              const img = document.createElement('img'); img.src = url; editorRoot.appendChild(img);
            }catch(e){ ph.innerHTML = `<div class="meta">Error</div>`; }
          }
        });
      }
      if (vidInput && previewRoot) {
        vidInput.addEventListener('change', async () => {
          for(const f of vidInput.files){
            const ph = document.createElement('div'); ph.className = 'ph';
            ph.innerHTML = `<div class="meta">Subiendo‚Ä¶</div>`;
            previewRoot.appendChild(ph);
            try{
              const url = await uploadToCloudinary(f);
              ph.innerHTML = `<video src="${url}" controls></video>`;
              const v = document.createElement('video'); v.src = url; v.controls = true; v.style.maxWidth="100%"; editorRoot.appendChild(v);
            }catch(e){ ph.innerHTML = `<div class="meta">Error</div>`; }
          }
        });
      }
    }

    // ===== Composer (crear hilo) =====
    document.getElementById('publishBtn').addEventListener('click', () => {
      if(!db){ alert("Configura Firebase para poder publicar hilos."); return; }
      if(!canInteract()){ alert("Inicia sesi√≥n para publicar un hilo."); return; }
      document.getElementById('composer').style.display = "flex";
      bindToolbar(document.querySelector('#composer .toolbar'), document.getElementById('pubEditor'), document.getElementById('pubPreview'));
    });
    document.getElementById('closeComposer').addEventListener('click', () => {
      document.getElementById('composer').style.display = "none";
    });
    document.getElementById('submitPost').addEventListener('click', async () => {
      if(!db){ alert("Configura Firebase para publicar."); return; }
      if(!canInteract()){ alert("Inicia sesi√≥n para publicar."); return; }
      const title = document.getElementById('pubTitle').value.trim();
      const description = document.getElementById('pubDescription').value.trim();
      const contentHtml = document.getElementById('pubEditor').innerHTML.trim();
      if(!title || !contentHtml){ alert("T√≠tulo y contenido son obligatorios."); return; }
      const coverUrl = pickFirstImage(contentHtml);
      const tag = "Noticias";
      try{
        const ref = await db.collection("posts").add({
          title, description, contentHtml, coverUrl: coverUrl || null,
          tag,
          author: { uid: currentUser.uid, name: currentUser.displayName, photo: currentUser.photoURL },
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          likesCount: 0
        });
        document.getElementById('composer').style.display = "none";
        await loadFeed(); // refresca
        const doc = await ref.get();
        openDetailCustom(doc.id, doc.data());
      }catch(e){
        alert("Error al publicar: " + e.message);
      }
    });

    // ===== Carga Feed =====
    async function loadFeed(){
      if (db) {
        const snap = await db.collection("posts").orderBy("updatedAt","desc").limit(50).get();
        await renderTickerFromFirestore();
        await renderForumFromFirestore(snap);
        renderTrendsFromFirestore(snap);
      } else {
        // Blogger fallback
        const url = `${BLOGGER_BASE}/blogs/${BLOG_ID}/posts?key=${BLOGGER_API_KEY}&fetchBodies=true&maxResults=50&orderBy=UPDATED`;
        const res = await fetch(url);
        if (!res.ok) {
          document.getElementById('forum').innerHTML = `<article class="thread"><div class="title-row"><div class="title">No se pudo cargar el feed</div></div><div class="excerpt">Verifica la API Key y el Blog ID.</div></article>`;
          return;
        }
        const data = await res.json();
        const items = data.items || [];
        await renderTickerFromBlogger(items);
        await renderForumFromBlogger(items);
        renderTrendsFromBlogger(items);
      }
    }

    // ===== B√∫squeda inicial y carga =====
    window.addEventListener('load', async () => {
      await loadFeed();
    });
  </script>
</body>
</html>
