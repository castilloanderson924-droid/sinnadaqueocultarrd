<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SIN NADA QUE OCULTAR ‚Äî Informaci√≥n libre y sin censura</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b0e14; --panel:#121825; --panel-2:#182235; --border:#24314a; --text:#eef2f7; --muted:#9fb0c7;
      --accent:#2ac3ff;
    }
    body.light{
      --bg:#f6f7fb; --panel:#ffffff; --panel-2:#f2f5f9; --border:#e5e7eb; --text:#0f172a; --muted:#64748b;
      --accent:#2563eb;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto}
    a{color:var(--accent);text-decoration:none}
    img{max-width:100%;display:block}

    /* Header */
    .header{background:var(--panel);padding:12px 16px;display:flex;align-items:center;gap:12px;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:5}
    .logo{width:40px;height:40px;border-radius:8px;border:1px solid var(--border);background:#0c1018;display:grid;place-items:center}
    .logo img{width:34px;height:34px;object-fit:contain}
    h1{margin:0;font-size:20px;font-family:"Playfair Display",serif}
    .slogan{font-size:12px;color:var(--muted)}
    .spacer{flex:1}
    .btn{background:var(--accent);color:#061218;padding:8px 12px;border:none;border-radius:8px;cursor:pointer;font-weight:700}
    .chip{display:flex;align-items:center;gap:6px}
    /* Switch */
    .switch{display:flex;align-items:center;gap:8px;margin-left:12px}
    .switch label{font-size:12px;color:var(--muted);font-weight:700}
    .switch input{width:44px;height:22px;appearance:none;background:#4b5563;border-radius:999px;position:relative;cursor:pointer;outline:none;border:1px solid var(--border)}
    .switch input:checked{background:var(--accent)}
    .switch input::before{content:"";position:absolute;width:18px;height:18px;border-radius:50%;background:#fff;top:2px;left:2px;transition:.3s}
    .switch input:checked::before{transform:translateX(22px)}

    /* Ticket News */
    .ticket{max-width:900px;margin:16px auto;padding:16px;background:var(--panel);border-radius:12px;border:1px solid var(--border)}
    .ticket h2{margin:0 0 8px;font-size:18px}
    .ticker{overflow:hidden;white-space:nowrap;border-top:1px solid var(--border);border-bottom:1px solid var(--border);padding:10px 0}
    .marquee{display:inline-block;animation:marq 28s linear infinite}
    @keyframes marq{from{transform:translateX(100%)}to{transform:translateX(-100%)}}
    .headline{display:inline-flex;align-items:center;gap:8px;margin-right:24px;background:var(--panel-2);border:1px solid var(--border);padding:6px 10px;border-radius:999px}
    .headline .title{font-weight:800}
    .headline .tags{font-size:12px;color:var(--muted)}

    /* Feed */
    .feed{max-width:900px;margin:20px auto;padding:0 16px}
    .feed-actions{display:flex;align-items:center;gap:10px;margin-bottom:12px}
    .filter{display:flex;gap:8px;flex-wrap:wrap}
    .filter .chip{padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:var(--panel-2);cursor:pointer;font-weight:700}
    .filter .chip.active{background:var(--accent);color:#061218;border-color:transparent}

    .post{background:var(--panel);padding:16px;border-radius:12px;margin-bottom:16px;border:1px solid var(--border)}
    .post h3{margin:0 0 6px}
    .meta{font-size:12px;color:var(--muted);margin-bottom:8px}
    .tags{display:flex;gap:6px;flex-wrap:wrap;margin:6px 0}
    .tag{font-size:12px;border:1px solid var(--border);padding:4px 8px;border-radius:999px;background:var(--panel-2)}
    .post-gallery img,.post-gallery video{width:100%;border-radius:8px;margin-top:8px;cursor:pointer;border:1px solid var(--border)}
    .empty{color:var(--muted);text-align:center;padding:20px}

    /* Modal composer */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:10}
    .modal{background:var(--panel);padding:16px;border-radius:12px;width:94%;max-width:640px;border:1px solid var(--border)}
    .modal h3{margin:0 0 10px}
    .editor{background:var(--panel-2);min-height:120px;padding:10px;border-radius:8px;margin-top:10px;color:var(--text);border:1px solid var(--border)}
    .inputs{display:grid;gap:10px}
    .inputs input,.inputs textarea,.inputs select{width:100%;background:var(--panel-2);color:var(--text);border:1px solid var(--border);border-radius:8px;padding:10px}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .tool{background:var(--panel-2);color:var(--text);border:1px solid var(--border);border-radius:8px;padding:6px 10px;font-weight:700;cursor:pointer}
    .mediaPreview{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .thumb{width:120px;height:80px;border-radius:8px;overflow:hidden;border:1px solid var(--border);display:flex;align-items:center;justify-content:center;background:#0b0d12}

    /* Lightbox */
    .lightbox{position:fixed;inset:0;background:rgba(0,0,0,.92);display:none;align-items:center;justify-content:center;z-index:20}
    .lightbox-content{max-width:92vw;max-height:92vh}
    .lightbox-content img,.lightbox-content video{max-width:100%;max-height:100%;border-radius:12px}
    .lightbox-close{position:absolute;top:16px;right:16px;background:#000;color:#fff;border:1px solid #333;border-radius:999px;padding:8px 12px;cursor:pointer;font-weight:800}
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="logo">
      <img alt="Logo SNQO" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjS8LXAzi1Yiook-sOoY1qALICMCqeaZIYKCGeGogvvyhP85GNNKH2nPshVJBRtdggNYOAB4JYP10iMRH7FD4887JXS9yiaY6g0dtRqkgj9Vmbuql5VqpzJ0gwUxsMzERwBlKxHbwUTFIwtBWJVPT-Du-HSg8gsbkIz4cl32AWD9fjbtm9p3FDnq4_Wpdc/s320/gg843.png">
    </div>
    <div>
      <h1>SIN NADA QUE OCULTAR</h1>
      <div class="slogan">INFORMACI√ìN LIBRE Y SIN SENSURA</div>
    </div>
    <div class="spacer"></div>
    <button id="googleBtn" class="btn">Iniciar sesi√≥n con Google</button>
    <div id="userChip" style="display:none;align-items:center;gap:8px">
      <img id="userAvatar" style="width:32px;height:32px;border-radius:50%;border:1px solid var(--border)">
      <span id="userName" style="font-weight:700"></span>
      <button id="logoutBtn" class="btn">Salir</button>
    </div>
    <div class="switch">
      <label for="themeToggle">Tema</label>
      <input type="checkbox" id="themeToggle">
    </div>
  </header>

  <!-- Ticket News -->
  <section class="ticket">
    <h2>√öltimas noticias</h2>
    <div class="ticker"><div id="marquee" class="marquee"></div></div>
  </section>

  <!-- Feed -->
  <section class="feed" id="feed">
    <div class="feed-actions">
      <button id="openComposer" class="btn">Crear publicaci√≥n</button>
      <div class="filter">
        <span class="chip active" data-type="all">Todo</span>
        <span class="chip" data-type="texto">Texto</span>
        <span class="chip" data-type="imagen">Im√°genes</span>
        <span class="chip" data-type="video">Videos</span>
      </div>
    </div>
    <div id="posts"></div>
    <div id="emptyFeed" class="empty">A√∫n no hay publicaciones.</div>
  </section>

  <!-- Modal Composer -->
  <div id="composerModal" class="modal-backdrop">
    <div class="modal">
      <h3>Crear publicaci√≥n</h3>
      <div class="inputs">
        <input id="titleInput" placeholder="T√≠tulo" maxlength="120">
        <textarea id="descInput" placeholder="Descripci√≥n breve" rows="3" maxlength="280"></textarea>
        <input id="tagsInput" placeholder="Etiquetas (separadas por comas)">
        <select id="contentType">
          <option value="texto">Texto</option>
          <option value="imagen">Im√°genes</option>
          <option value="video">Videos</option>
        </select>
      </div>
      <div class="toolbar">
        <button class="tool" data-cmd="bold">Negrita</button>
        <button class="tool" data-cmd="italic">Cursiva</button>
        <button class="tool" data-cmd="underline">Subrayado</button>
        <button class="tool" data-cmd="insertUnorderedList">Lista</button>
        <button class="tool" data-cmd="formatBlock" data-value="blockquote">Cita</button>
        <button class="tool" id="linkBtn">Enlace</button>
        <button class="tool" data-cmd="formatBlock" data-value="h2">H2</button>
        <button class="tool" data-cmd="formatBlock" data-value="h3">H3</button>
        <button class="tool" id="clearFormat">Limpiar formato</button>
      </div>
      <div id="editor" class="editor" contenteditable="true">Escribe aqu√≠ tu contenido‚Ä¶</div>
      <input id="mediaInput" type="file" accept="image/*,video/*" multiple style="margin-top:10px">
      <div id="mediaPreview" class="mediaPreview"></div>
      <div style="margin-top:12px;display:flex;gap:10px;justify-content:flex-end">
        <button id="publishBtn" class="btn">Publicar</button>
        <button id="closeComposer" class="btn" style="background:#334155;color:#fff">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Lightbox -->
  <div id="lightbox" class="lightbox">
    <button id="lightboxClose" class="lightbox-close">Cerrar ‚úï</button>
    <div class="lightbox-content"></div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>

  <script>
    // Firebase config (tu proyecto)
    const firebaseConfig = {
      apiKey: "AIzaSyBWqJI7OKZcEjN2CeTZxPi8pWzo8rBMIkI",
      authDomain: "nearmemarketplace-ce82b.firebaseapp.com",
      projectId: "nearmemarketplace-ce82b",
      storageBucket: "nearmemarketplace-ce82b.firebasestorage.app",
      messagingSenderId: "711845990024",
      appId: "1:711845990024:web:7948ad5e5606765514d93d",
      measurementId: "G-X75JHEDQJ0"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const firestore = firebase.firestore();

    // Cloudinary config
    const CLOUDINARY_CLOUD_NAME = "dxbahdjk1";
    const CLOUDINARY_UPLOAD_PRESET = "nearmemarketplace"; // unsigned
    const CLOUDINARY_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/auto/upload`;

    // Theme switch (persistente)
    const themeToggle = document.getElementById('themeToggle');
    const savedTheme = localStorage.getItem('snqo_theme');
    if (savedTheme === 'light') { document.body.classList.add('light'); themeToggle.checked = true; }
    themeToggle.addEventListener('change', () => {
      const light = themeToggle.checked;
      document.body.classList.toggle('light', light);
      localStorage.setItem('snqo_theme', light ? 'light' : 'dark');
    });

    // Auth UI
    const googleBtn=document.getElementById('googleBtn');
    const userChip=document.getElementById('userChip');
    const userAvatar=document.getElementById('userAvatar');
    const userName=document.getElementById('userName');
    const logoutBtn=document.getElementById('logoutBtn');

    googleBtn.onclick=async()=>{
      const provider=new firebase.auth.GoogleAuthProvider();
      try{await auth.signInWithPopup(provider);}catch(e){alert("Error al iniciar sesi√≥n: "+e.message);}
    };
    logoutBtn.onclick=()=>auth.signOut();
    auth.onAuthStateChanged(u=>{
      if(u){googleBtn.style.display="none";userChip.style.display="flex";userName.textContent=u.displayName||u.email;userAvatar.src=u.photoURL||('https://ui-avatars.com/api/?name='+encodeURIComponent(u.displayName||'Usuario'));}
      else{googleBtn.style.display="inline-block";userChip.style.display="none";}
    });

    // Modal composer
    const composerModal=document.getElementById('composerModal');
    document.getElementById('openComposer').onclick=()=>{
      if(!auth.currentUser){alert("Inicia sesi√≥n con Google para publicar.");return;}
      composerModal.style.display="flex";
    };
    document.getElementById('closeComposer').onclick=()=>composerModal.style.display="none";
    composerModal.addEventListener('click',(e)=>{if(e.target===composerModal)composerModal.style.display="none";});

    // Editor toolbar
    const editor=document.getElementById('editor');
    document.querySelectorAll('.tool').forEach(btn=>{
      const cmd=btn.dataset.cmd; const val=btn.dataset.value;
      if(cmd && cmd!=='formatBlock'){btn.addEventListener('click',()=>document.execCommand(cmd,false,null));}
      else if(cmd==='formatBlock'){btn.addEventListener('click',()=>document.execCommand('formatBlock',false,val));}
    });
    document.getElementById('linkBtn').addEventListener('click',()=>{
      const url=prompt('URL del enlace:'); if(url) document.execCommand('createLink',false,url);
    });
    document.getElementById('clearFormat').addEventListener('click',()=>document.execCommand('removeFormat',false,null));

    // Media preview
    const mediaInput=document.getElementById('mediaInput');
    const mediaPreview=document.getElementById('mediaPreview');
    let selectedFiles=[];
    mediaInput.onchange=()=>{
      selectedFiles=Array.from(mediaInput.files).slice(0,6);
      mediaPreview.innerHTML="";
      selectedFiles.forEach(f=>{
        const t=document.createElement('div'); t.className='thumb';
        if(f.type.startsWith('image/')){const img=document.createElement('img'); img.src=URL.createObjectURL(f); t.appendChild(img);}
        else{const v=document.createElement('video'); v.src=URL.createObjectURL(f); v.muted=true; v.loop=true; v.autoplay=true; t.appendChild(v);}
        mediaPreview.appendChild(t);
      });
    };

    // Upload to Cloudinary
    async function uploadToCloudinary(files, uid){
      const items=[];
      for(const file of files){
        const fd=new FormData();
        fd.append('file',file);
        fd.append('upload_preset',CLOUDINARY_UPLOAD_PRESET);
        fd.append('folder',`snqo/${uid}`);
        const res=await fetch(CLOUDINARY_URL,{method:'POST',body:fd});
        if(!res.ok) throw new Error('Fall√≥ la subida a Cloudinary');
        const data=await res.json();
        items.push({url:data.secure_url,type:data.resource_type==='video'?'video':'image',public_id:data.public_id});
      }
      return items;
    }

    // Publicar
    const titleInput=document.getElementById('titleInput');
    const descInput=document.getElementById('descInput');
    const tagsInput=document.getElementById('tagsInput');
    const contentType=document.getElementById('contentType');
    const publishBtn=document.getElementById('publishBtn');

    publishBtn.onclick=async()=>{
      const user=auth.currentUser;
      if(!user){alert("Inicia sesi√≥n para publicar.");return;}
      const title=titleInput.value.trim();
      const desc=descInput.value.trim();
      const bodyHtml=editor.innerHTML.trim();
      const tags=tagsInput.value.split(',').map(t=>t.trim().toLowerCase()).filter(Boolean);
      const type=contentType.value; // texto | imagen | video
      if(!title||!desc||!bodyHtml){alert("Completa t√≠tulo, descripci√≥n y cuerpo.");return;}
      if((type==='imagen'||type==='video') && selectedFiles.length===0){
        const ok=confirm('Seleccionaste "'+type+'", pero no adjuntaste archivos. ¬øPublicar de todas formas?'); if(!ok) return;
      }
      const original = publishBtn.textContent;
      publishBtn.disabled=true; publishBtn.textContent="Publicando‚Ä¶";
      try{
        const mediaItems=selectedFiles.length?await uploadToCloudinary(selectedFiles,user.uid):[];
        await firestore.collection('posts').add({
          title, desc, bodyHtml, tags, type,
          author:{uid:user.uid,name:user.displayName||user.email||'Usuario',avatar:user.photoURL||null},
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          media: mediaItems,
          likesCount: 0, likedBy: []
        });
        // reset
        titleInput.value=''; descInput.value=''; tagsInput.value=''; contentType.value='texto';
        editor.innerHTML=''; mediaInput.value=''; selectedFiles=[]; mediaPreview.innerHTML='';
        publishBtn.textContent="Publicado ‚úî";
        setTimeout(()=>{ publishBtn.textContent=original; publishBtn.disabled=false; composerModal.style.display="none"; },800);
      }catch(e){
        alert("Error publicando: "+e.message);
        publishBtn.textContent=original; publishBtn.disabled=false;
      }
    };

    // Feed + filters + headlines
    const postsContainer=document.getElementById('posts');
    const emptyFeed=document.getElementById('emptyFeed');
    const typeChips=document.querySelectorAll('[data-type]');
    let currentType='all';
    typeChips.forEach(ch=>{
      ch.addEventListener('click',()=>{
        typeChips.forEach(c=>c.classList.remove('active'));
        ch.classList.add('active');
        currentType=ch.dataset.type;
        renderAllPosts();
      });
    });

    let allPosts=[];
    firestore.collection('posts').orderBy('createdAt','desc').onSnapshot(snap=>{
      allPosts=[];
      if(snap.empty){
        postsContainer.innerHTML=''; emptyFeed.style.display='block'; document.getElementById('marquee').innerHTML='';
        return;
      }
      snap.forEach(doc=>{
        const d=doc.data();
        let created='‚Äî'; try{ if(d.createdAt?.toDate) created=d.createdAt.toDate().toLocaleString(); }catch(e){}
        allPosts.push({ id: doc.id, data: { ...d, createdText: created } });
      });
      emptyFeed.style.display='none';
      renderAllPosts();
      renderHeadlines(allPosts.slice(0,20)); // √∫ltimos t√≠tulos en ticket
    });

    function renderAllPosts(){
      postsContainer.innerHTML='';
      const filtered = allPosts.filter(p=>{
        if(currentType==='all') return true;
        return (p.data.type===currentType);
      });
      if(!filtered.length){ postsContainer.innerHTML='<div class="empty">No hay publicaciones para el filtro.</div>'; return; }
      filtered.forEach(p=>postsContainer.appendChild(postCard(p.id,p.data)));
    }

    function postCard(id,d){
      const card=document.createElement('article'); card.className='post';
      const h3=document.createElement('h3'); h3.textContent=d.title;
      const meta=document.createElement('div'); meta.className='meta'; meta.textContent=(d.author?.name||'Usuario')+' ‚Ä¢ '+d.createdText;
      const tagsRow=document.createElement('div'); tagsRow.className='tags';
      (d.tags||[]).forEach(t=>{ const s=document.createElement('span'); s.className='tag'; s.textContent='#'+t; tagsRow.appendChild(s); });
      const desc=document.createElement('p'); desc.textContent=d.desc;
      const body=document.createElement('div'); body.innerHTML=d.bodyHtml;

      const gallery=document.createElement('div'); gallery.className='post-gallery';
      (d.media||[]).forEach(m=>{
        if(m.type==='image'){ const img=document.createElement('img'); img.src=m.url; img.alt=d.title; img.onclick=()=>openLightbox('image',m.url); gallery.appendChild(img); }
        else if(m.type==='video'){ const v=document.createElement('video'); v.src=m.url; v.controls=true; v.onclick=()=>openLightbox('video',m.url); gallery.appendChild(v); }
      });

      card.appendChild(h3); card.appendChild(meta); card.appendChild(tagsRow); card.appendChild(desc); card.appendChild(body);
      if((d.media||[]).length) card.appendChild(gallery);
      return card;
    }

    // Headlines marquee (ticket news)
    function renderHeadlines(posts){
      const marquee=document.getElementById('marquee');
      marquee.innerHTML='';
      const seq=[...posts, ...posts]; // duplicar para loop continuo
      seq.forEach(p=>{
        const d=p.data||p; // soporta ambos
        const pill=document.createElement('span'); pill.className='headline';
        const tags=(d.tags||[]).slice(0,3).join(' ‚Ä¢ ')||'sin etiquetas';
        pill.innerHTML=`<span class="title">üì∞ ${escapeHtml(d.title)}</span> <span class="tags">(${tags})</span>`;
        marquee.appendChild(pill);
      });
    }

    // Lightbox
    const lightbox=document.getElementById('lightbox');
    const lightboxContent=document.querySelector('.lightbox-content');
    const lightboxClose=document.getElementById('lightboxClose');
    function openLightbox(type,url){
      lightboxContent.innerHTML='';
      if(type==='image'){ const img=document.createElement('img'); img.src=url; lightboxContent.appendChild(img); }
      else{ const vid=document.createElement('video'); vid.src=url; vid.controls=true; vid.autoplay=true; lightboxContent.appendChild(vid); }
      lightbox.style.display='flex';
    }
    lightboxClose.onclick=()=>lightbox.style.display='none';
    lightbox.addEventListener('click',(e)=>{ if(e.target===lightbox) lightbox.style.display='none'; });

    // Helpers
    function escapeHtml(str){ return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[s]); }
  </script>
</body>
</html>
